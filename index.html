<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙƒØ§ÙƒÙŠÙ†</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --warning:#f1c40f; --info:#3498db; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:80px; overflow-x: hidden; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background:white; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
        input, select, textarea { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:8px; box-sizing:border-box; font-family:'Cairo'; font-size: 16px; }
        .main-btn { width:100%; padding:15px; border:none; border-radius:10px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; margin-top:10px; font-family:'Cairo'; }
        
        /* Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª */
        #admin-ads { display:none; background:var(--warning); color:#2c3e50; padding:10px; position:sticky; top:0; z-index:5000; text-align: center; font-weight: bold; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #lock-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; text-align:center; display:none; }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-tabs { display: flex; justify-content: space-around; background: white; padding: 10px 0; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #ddd; z-index: 1000; }
        .tab-btn { border: none; background: none; font-family: 'Cairo'; cursor: pointer; color: #7f8c8d; font-size: 12px; }
        .tab-btn.active { color: var(--primary); font-weight: bold; }
        .page { display: none; } .page.active { display: block; }

        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; width:90%; max-width:400px; padding:20px; border-radius:20px; text-align: center; }
    </style>
</head>
<body>

<div id="admin-ads"><marquee id="ad-text"></marquee></div>

<div id="lock-screen">
    <h2 style="margin-top:100px;">ğŸª Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙƒØ§ÙƒÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ</h2>
    <p>Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
    <input type="password" id="access-code" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="text-align:center;">
    <button class="main-btn" onclick="verifyAccess()">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
</div>

<div id="main-app" class="container">
    <div id="home-page" class="page active">
        <div id="status-card" class="card" style="background:var(--primary); color:white; text-align:center;">
            <h3 id="store-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
            <small>ØµØ§ÙÙŠ Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…</small>
            <h1 id="profit-display" style="margin:10px 0;">0</h1>
        </div>

        <div class="card" style="background:var(--secondary); color:white; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
            <div style="grid-column: span 2; border-bottom: 1px solid #444; padding-bottom: 5px;">ğŸ“Š Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„ÙƒÙ„ÙŠØ©</div>
            <div><small>Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ</small><h3 id="stock-buy-total">0</h3></div>
            <div><small>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨ÙŠØ¹</small><h3 id="stock-sell-total">0</h3></div>
        </div>

        <div class="card">
            <h4>ğŸ“¢ Ø¨Ù„Ø§Øº Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</h4>
            <textarea id="report-msg" placeholder="Ø§ÙƒØªØ¨ Ø¨Ù„Ø§ØºÙƒ Ù‡Ù†Ø§..."></textarea>
            <button class="main-btn" style="background:var(--info);" onclick="sendReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
        </div>

        <button class="main-btn" style="background:var(--danger)" onclick="resetDailySales()">ğŸ ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
    </div>

    <div id="sell-page" class="page">
        <div class="card">
            <h4>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h4>
            <select id="p-select" onchange="updatePrice()"><option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option></select>
            <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <input type="number" id="p-price" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø­Ø¨Ø©" readonly style="background:#f9f9f9;">
            <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ğŸ–¨ï¸</button>
        </div>
    </div>

    <div id="stock-page" class="page">
        <div class="card">
            <h4>ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h4>
            <input type="text" id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
            <input type="number" id="in-buy" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
            <input type="number" id="in-sell" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
            <input type="number" id="in-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©">
            <button class="main-btn" onclick="saveToStock()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>
        <div class="card">
            <h4>ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø£Ùˆ Ø®Ø³Ø§Ø±Ø©</h4>
            <input type="text" id="exp-name" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù† (ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ ØªØ§Ù„Ù..)">
            <input type="number" id="exp-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <button class="main-btn" style="background:var(--secondary)" onclick="saveExp()">Ø­ÙØ¸</button>
        </div>
    </div>
</div>

<nav class="nav-tabs">
    <button class="tab-btn active" onclick="tab('home-page', this)">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab-btn" onclick="tab('sell-page', this)">ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    <button class="tab-btn" onclick="tab('stock-page', this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
</nav>

<script>
    // 1. Firebase Config (Ø¶Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù‡Ù†Ø§)
    const firebaseConfig = { apiKey: "AIza...", databaseURL: "https://...", projectId: "..." };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let db = {
        p: JSON.parse(localStorage.getItem('p')) || [],
        s: JSON.parse(localStorage.getItem('s')) || [],
        e: JSON.parse(localStorage.getItem('e')) || []
    };

    const storeId = localStorage.getItem('storeId');

    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­ÙŠØ© (Ø¥Ø¯Ø§Ø±Ø© + Ø¯ÙƒØ§Ù†)
    if(!localStorage.getItem('active')) {
        document.getElementById('lock-screen').style.display = 'block';
    } else {
        document.getElementById('store-title').innerText = localStorage.getItem('storeName');
        startLiveSync();
        getGPS();
    }

    function startLiveSync() {
        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙŠ Firebase (Ø­Ø°ÙØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø¥Ø¶Ø§ÙØ©)
        database.ref('stores/' + storeId + '/inventory').on('value', snap => {
            if(snap.exists()) {
                db.p = snap.val();
                localStorage.setItem('p', JSON.stringify(db.p));
                render();
            }
        });

        database.ref('global_ads').on('value', snap => {
            const ad = snap.val();
            if(ad && ad.active) {
                document.getElementById('admin-ads').style.display = 'block';
                document.getElementById('ad-text').innerText = ad.text;
            } else {
                document.getElementById('admin-ads').style.display = 'none';
            }
        });
    }

    // 3. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ©
    function saveToStock() {
        const n=document.getElementById('in-name'), b=document.getElementById('in-buy'), s=document.getElementById('in-sell'), q=document.getElementById('in-qty');
        if(!n.value || +q.value <= 0) return;
        db.p.push({name: n.value, buy: +b.value, sell: +s.value, qty: +q.value});
        sync();
        n.value=b.value=s.value=q.value=""; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    }

    function doSale() {
        const sel=document.getElementById('p-select'), qy=document.getElementById('p-qty');
        if(sel.value==="" || +qy.value <= 0) return;
        let item = db.p[sel.value];
        if(item.qty < +qy.value) return alert("Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ø§ ÙŠÙƒÙÙŠ!");

        const profit = (item.sell - item.buy) * +qy.value;
        db.s.push({p: profit, date: new Date().toLocaleDateString()});
        item.qty -= +qy.value;
        sync();
        sel.value=""; qy.value=""; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    }

    function saveExp() {
        const n=document.getElementById('exp-name'), a=document.getElementById('exp-amt');
        if(!n.value || +a.value <= 0) return;
        db.e.push({name: n.value, amt: +a.value, date: new Date().toLocaleDateString()});
        sync();
        n.value=""; a.value="";
    }

    function sync() {
        localStorage.setItem('p', JSON.stringify(db.p));
        localStorage.setItem('s', JSON.stringify(db.s));
        localStorage.setItem('e', JSON.stringify(db.e));
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù€ Firebase Ù„Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        database.ref('stores/' + storeId + '/inventory').set(db.p);
        database.ref('stores/' + storeId + '/daily_stats').set({ s: db.s, e: db.e });
        render();
    }

    function render() {
        const sel = document.getElementById('p-select');
        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option>';
        
        let stockBuy = 0, stockSell = 0;
        db.p.forEach((x,i) => {
            if(x.qty > 0) {
                sel.innerHTML += `<option value="${i}">${x.name} (${x.qty})</option>`;
                stockBuy += (x.buy * x.qty);
                stockSell += (x.sell * x.qty);
            }
        });

        document.getElementById('stock-buy-total').innerText = stockBuy + " Ø¬";
        document.getElementById('stock-sell-total').innerText = stockSell + " Ø¬";

        const today = new Date().toLocaleDateString();
        const p = db.s.filter(x=>x.date===today).reduce((a,b)=>a+b.p,0);
        const e = db.e.filter(x=>x.date===today).reduce((a,b)=>a+b.amt,0);
        
        const total = p - e;
        const display = document.getElementById('profit-display');
        display.innerText = total + " Ø¬";
        
        // ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        document.getElementById('status-card').style.background = (total < 0) ? "var(--danger)" : "var(--primary)";
        if(total < 0) display.innerText += " (Ø®Ø³Ø§Ø±Ø© âš ï¸)";
    }

    // 4. ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø©
    function verifyAccess() {
        const code = document.getElementById('access-code').value;
        database.ref('activations/' + code).once('value', snap => {
            if(snap.exists()){
                localStorage.setItem('active', 'true');
                localStorage.setItem('storeId', code);
                localStorage.setItem('storeName', snap.val().name);
                location.reload();
            }
        });
    }

    function sendReport() {
        const m = document.getElementById('report-msg').value;
        database.ref('reports').push({ store: localStorage.getItem('storeName'), msg: m, time: new Date().toLocaleString() });
        document.getElementById('report-msg').value = "";
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
    }

    function resetDailySales() {
        if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ØŸ")) { db.s=[]; db.e=[]; sync(); }
    }

    function tab(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function updatePrice() {
        const i = document.getElementById('p-select').value;
        if(i!=="") document.getElementById('p-price').value = db.p[i].sell;
    }

    function getGPS() { 
        navigator.geolocation.getCurrentPosition(pos => {
            database.ref('stores/'+storeId+'/location').set({lat: pos.coords.latitude, lng: pos.coords.longitude});
        }); 
    }

    render();
</script>
</body>
</html>
