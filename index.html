<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø°ÙƒÙŠØ© | M-TAHA</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --p: #1e3799; --s: #4a69bd; --gold: #f6b93b; --red: #eb2f06; --green: #38ada9; --bg: #f1f2f6; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); margin: 0; padding-bottom: 70px; }
        header { background: var(--p); color: white; padding: 20px; text-align: center; border-radius: 0 0 25px 25px; }
        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; padding: 15px; margin-top: -25px; }
        .stat-card { background: white; padding: 10px; border-radius: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-card b { display: block; font-size: 13px; color: #7f8c8d; }
        .stat-card span { color: var(--p); font-weight: 900; font-size: 18px; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .v-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .v-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; text-align: center; font-size: 16px; }
        .v-btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; }
        .btn-green { background: var(--green); } .btn-red { background: var(--red); }
        .low-stock { border: 2px solid var(--red) !important; color: var(--red); background: #fff5f5; }
        .badge-red { background: var(--red); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; }
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #ddd; }
        .nav-link { background: none; border: none; color: #7f8c8d; font-weight: bold; font-size: 14px; }
        .nav-link.active { color: var(--p); border-bottom: 2px solid var(--p); }
        .page { display: none; } .page.active { display: block; }
        #toast { position: fixed; top: 20px; width: 80%; left: 10%; background: #333; color: white; padding: 12px; border-radius: 10px; text-align: center; display: none; z-index: 1000; font-weight: bold; }
    </style>
</head>
<body>

<div id="toast"></div>

<header>
    <h3 id="store-title" style="margin:0">Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø°ÙƒÙŠØ©</h3>
    <small id="season-alert" style="color:var(--gold); font-weight:bold"></small>
</header>

<div class="stats-bar">
    <div class="stat-card"><b>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</b><span id="s-profit">0</span></div>
    <div class="stat-card"><b>Ù…Ø¨ÙŠØ¹Ø§Øª ÙƒØ§Ø´</b><span id="s-cash">0</span></div>
    <div class="stat-card"><b>Ø¯ÙŠÙˆÙ† Ù…Ø¹Ù„Ù‚Ø©</b><span id="s-debt" style="color:var(--red)">0</span></div>
</div>

<div class="container">
    <div id="pg-sale" class="page active">
        <div class="v-card">
            <h4 style="margin:0 0 10px 0">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</h4>
            <label style="font-size: 12px;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù:</label>
            <select id="p-select" class="v-input"></select>
            <input type="number" id="p-qty" class="v-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">
            <input type="text" id="p-cust" class="v-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† (Ù„Ù„Ø¯ÙŠÙ†)">
            <button class="v-btn btn-green" onclick="makeSale(false)">Ø¨ÙŠØ¹ ÙƒØ§Ø´ (ÙˆØ§Ù‚Ø¨Ø¶) âœ…</button>
            <button class="v-btn btn-red" style="margin-top:10px" onclick="makeSale(true)">ØªØ³Ø¬ÙŠÙ„ Ø¯ÙŠÙ† ğŸ¤</button>
        </div>
        
        <div class="v-card">
            <h4>ğŸ“¦ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙÙˆÙ ÙˆØ§Ù„Ù…Ø®Ø²Ù†</h4>
            <div id="stock-view"></div>
        </div>
    </div>

    <div id="pg-debt" class="page">
        <div class="v-card">
            <h4>ğŸ““ Ø¯ÙØªØ± Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†</h4>
            <div id="debt-view"></div>
        </div>
    </div>
</div>

<nav>
    <button class="nav-link active" onclick="tab('pg-sale',this)">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="nav-link" onclick="tab('pg-debt',this)">ğŸ““ Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
</nav>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ²
    const cfg = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
    firebase.initializeApp(cfg); const db = firebase.database();
    const sid = "STORE_01"; 
    let inv = [], sls = [];

    // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ
    db.ref('stores/'+sid).on('value', s => {
        const d = s.val() || {};
        if(d.status === 'off') {
            document.body.innerHTML = "<div style='text-align:center; padding:50px;'><h1 style='color:red'>âš ï¸ Ø§Ù„Ù…ØªØ¬Ø± Ù…ØªÙˆÙ‚Ù</h1><p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø­Ù…Ø¯ Ø·Ù‡)</p></div>";
            return;
        }
        inv = d.inventory || []; sls = d.sales || [];
        document.getElementById('store-title').innerText = d.name || "Ø¨Ù‚Ø§Ù„ØªÙ†Ø§ Ø§Ù„Ø°ÙƒÙŠØ©";
        checkSeason(); render();
    });

    function render() {
        let profit = 0, cash = 0, debt = 0;
        const sel = document.getElementById('p-select'); sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option>';
        const view = document.getElementById('stock-view'); view.innerHTML = '';
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
        inv.forEach((x, i) => {
            sel.innerHTML += `<option value="${i}">${x.name} (Ù…ØªÙˆÙØ±: ${x.qty})</option>`;
            const isLow = x.qty < 5;
            view.innerHTML += `<div class="v-card ${isLow?'low-stock':''}" style="margin-bottom:8px; padding:10px; display:flex; justify-content:space-between; align-items:center">
                <span>${x.name} ${isLow?'<span class="badge-red">Ù†ÙØ¯</span>':''}</span>
                <b>${x.qty} Ù‚Ø·Ø¹Ø©</b>
            </div>`;
        });

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
        const dView = document.getElementById('debt-view'); dView.innerHTML = '';
        sls.forEach((x, i) => {
            if(!x.isD) { 
                cash += x.total; 
                profit += x.profit; 
            } else { 
                debt += x.total;
                dView.innerHTML += `<div class="v-card" style="border-right: 5px solid var(--red)">
                    <div style="display:flex; justify-content:space-between">
                        <b>${x.cust}</b>
                        <span style="color:var(--red); font-weight:bold">${x.total} Ø¬.Ø³</span>
                    </div>
                    <small>${x.pname} - ${x.date}</small>
                    <button onclick="payDebt(${i})" style="width:100%; margin-top:10px; background:var(--green); border:none; color:white; padding:8px; border-radius:5px; font-weight:bold; cursor:pointer">ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº âœ…</button>
                </div>`;
            }
        });
        document.getElementById('s-profit').innerText = profit.toFixed(1);
        document.getElementById('s-cash').innerText = cash.toFixed(1);
        document.getElementById('s-debt').innerText = debt.toFixed(1);
    }

    function makeSale(isD) {
        const idx = document.getElementById('p-select').value;
        const q = parseInt(document.getElementById('p-qty').value);
        if(idx === "" || isNaN(q)) return toast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù ÙˆÙƒÙ…ÙŠØ©");

        let itm = inv[idx];
        if(itm.qty < q) return toast("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ© ÙÙŠ Ø§Ù„Ø±Ù!");
        
        const prf = (itm.sell - itm.buy) * q;
        if(prf < 0 && !confirm("ØªÙ†Ø¨ÙŠÙ‡: Ø³ØªØ¨ÙŠØ¹ Ø¨Ø®Ø³Ø§Ø±Ø©! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;

        itm.qty -= q;
        sls.push({
            pname: itm.name, 
            total: itm.sell * q, 
            profit: prf, 
            isD: isD, 
            cust: document.getElementById('p-cust').value || 'Ø²Ø¨ÙˆÙ† Ø¹Ø§Ø¨Ø±', 
            date: new Date().toLocaleString('ar-EG')
        });

        db.ref('stores/'+sid).update({ inventory: inv, sales: sls })
          .then(() => {
              toast(isD ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯ÙØªØ± ğŸ““" : "ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
              document.getElementById('p-qty').value = '';
              document.getElementById('p-cust').value = '';
          });
    }

    function payDebt(i) {
        if(confirm("Ù‡Ù„ Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ù‚Ø±ÙˆØ´ ÙƒØ§Ø´ØŸ")) {
            sls[i].isD = false;
            db.ref('stores/'+sid+'/sales').set(sls).then(()=>toast("ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ø¯ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­"));
        }
    }

    function checkSeason() {
        const m = new Date().getMonth() + 1;
        let msg = "";
        if(m === 2 || m === 3) msg = "ğŸŒ™ ØªÙ†Ø¨ÙŠÙ‡: Ù…ÙˆØ³Ù… Ø±Ù…Ø¶Ø§Ù† - Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙƒØ± ÙˆØ§Ù„Ø¨Ù„Ø­ ÙˆØ§Ù„Ø²ÙŠÙˆØª!";
        if(m === 6 || m === 7) msg = "ğŸ‘ ØªÙ†Ø¨ÙŠÙ‡: Ø¹ÙŠØ¯ Ø§Ù„Ø¶Ø­ÙŠØ© - Ø¬Ù‡Ù‘Ø² Ø¨Ø¶Ø§Ø¦Ø¹ Ø§Ù„Ø¶ÙŠØ§ÙØ© ÙˆØ§Ù„ØªÙˆØ§Ø¨Ù„!";
        document.getElementById('season-alert').innerText = msg;
    }

    function toast(m) { 
        const t = document.getElementById('toast'); 
        t.innerText = m; t.style.display = 'block'; 
        setTimeout(()=>t.style.display='none', 3000); 
    }

    function tab(id, b) { 
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); 
        document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
        document.getElementById(id).classList.add('active'); 
        b.classList.add('active');
    }
</script>
</body>
</html>
