<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M-TAHA ERP | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

    <style>
        :root { 
            --main-color: #059669; 
            --bg-soft: #f8fafc; 
            --safe-bottom: env(safe-area-inset-bottom, 15px);
        }
        
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-soft); 
            color: #1e293b; 
            overflow-x: hidden; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: pan-y; 
        }
        
        #auth-screen { background: linear-gradient(135deg, #059669 0%, #064e3b 100%); z-index: 9999; }
        
        .app-header { background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; }
        
        .nav-bottom { 
            position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; 
            display: flex; z-index: 1000; padding-top: 10px; padding-bottom: var(--safe-bottom);
            height: calc(65px + var(--safe-bottom)); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); 
        }

        .nav-link-custom { flex: 1; text-align: center; color: #64748b; text-decoration: none; font-size: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .nav-link-custom.active { color: var(--main-color); transform: scale(1.1); }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª */
        #swipe-area { position: relative; width: 100%; transition: transform 0.3s ease-out; }
        
        .page { 
            display: none; 
            padding: 20px; 
            min-height: 80vh;
            animation: fadeIn 0.4s ease-in-out;
        }
        .page.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .container-fluid { padding-bottom: 100px; }
        .card-custom { background: white; border: none; border-radius: 15px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .alert-low { background: #fff1f2; border-right: 5px solid #e11d48; color: #9f1239; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: 600; }

        @media print { .no-print, .nav-bottom, .btn, .app-header { display: none !important; } }
    </style>
</head>
<body>

<div id="auth-screen" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center text-white">
    <div class="text-center p-4 w-100" style="max-width: 400px;">
        <h1 class="fw-900 mb-3">M-TAHA ERP</h1>
        <div class="bg-white p-4 rounded-4 shadow-lg">
            <input type="text" id="auth-code" class="form-control form-control-lg mb-3 text-center border-2" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„" style="-webkit-text-security: disc;">
            <button class="btn btn-success btn-lg w-100 fw-bold" onclick="login()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>
</div>

<div id="main-app" style="display: none;">
    <header class="app-header p-3 d-flex justify-content-between align-items-center no-print">
        <span class="fw-bold text-success fs-5" id="store-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </header>

    <div class="container-fluid" id="swipe-area">
        <div id="p-reports" class="page active">
            <div class="row g-3">
                <div class="col-6"><div class="card-custom text-center border-bottom border-success border-4">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…<h3 id="stat-profit" class="fw-bold text-success m-0">0</h3></div></div>
                <div class="col-6"><div class="card-custom text-center border-bottom border-primary border-4">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²Ù†<h3 id="stat-stock-val" class="fw-bold text-primary m-0">0</h3></div></div>
            </div>
            <div class="card-custom mt-3"><h6>ğŸš¨ Ù†ÙˆØ§Ù‚Øµ ÙŠØ¬Ø¨ ØªÙˆÙÙŠØ±Ù‡Ø§</h6><div id="low-stock-container"></div></div>
            <div class="card-custom"><h6>ğŸ“Š Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h6><div class="table-responsive"><table class="table small"><tbody id="sales-table-body"></tbody></table></div></div>
            <button class="btn btn-dark w-100 py-3 fw-bold" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</button>
        </div>

        <div id="p-pos" class="page">
            <div class="card-custom border-top border-success border-4">
                <h5 class="fw-bold mb-4">ğŸ›’ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <input type="text" id="pos-search" class="form-control p-3 mb-2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="filterPOS()">
                <select id="pos-select" class="form-select mb-2" size="5" onchange="autoPrice()"></select>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small text-muted">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="pos-qty" class="form-control fw-bold" value="1"></div>
                    <div class="col-6"><label class="small text-muted">Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="pos-price" class="form-control fw-bold text-success"></div>
                </div>
                <button class="btn btn-success w-100 py-3 fw-bold fs-5 shadow" onclick="submitSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
            </div>
        </div>

        <div id="p-stock" class="page">
            <div class="card-custom border-top border-primary border-4">
                <h5 id="stock-title" class="fw-bold mb-3">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²Ù†</h5>
                <input id="st-name" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                <div class="row g-2">
                    <div class="col-4"><input id="st-qty" type="number" class="form-control" placeholder="ÙƒÙ…ÙŠØ©"></div>
                    <div class="col-4"><input id="st-buy" type="number" class="form-control" placeholder="Ø´Ø±Ø§Ø¡"></div>
                    <div class="col-4"><input id="st-sell" type="number" class="form-control" placeholder="Ø¨ÙŠØ¹"></div>
                </div>
                <button class="btn btn-primary w-100 mt-3 fw-bold" onclick="saveToStock()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</button>
            </div>
            <div id="stock-list-container"></div>
        </div>
    </div>

    <nav class="nav-bottom no-print">
        <a class="nav-link-custom active" id="nav-reports" onclick="showPage('reports')">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        <a class="nav-link-custom" id="nav-pos" onclick="showPage('pos')">ğŸ›’ Ø§Ù„Ø¨ÙŠØ¹</a>
        <a class="nav-link-custom" id="nav-stock" onclick="showPage('stock')">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</a>
    </nav>
</div>

<script>
// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
const firebaseConfig = {
    apiKey: "AIzaSyAYJwvrBLc_svZ2IcWBzrBbK_ZpUqX0G8M",
    databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com",
    projectId: "store-project-b023e",
    appId: "1:561530737705:web:beefb32c081f9bf8b53838"
};
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let sid = localStorage.getItem('m_taha_sid'), data = { p: [], s: [] };
const pages = ['reports', 'pos', 'stock'];
let currentPageIdx = 0;

// --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø·ÙˆØ± ---
document.addEventListener('DOMContentLoaded', () => {
    const swipeArea = document.getElementById('swipe-area');
    const hammer = new Hammer(swipeArea);

    // Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± (Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©)
    hammer.on('swipeleft', () => {
        if (currentPageIdx < pages.length - 1) {
            currentPageIdx++;
            showPage(pages[currentPageIdx], 'next');
        }
    });

    // Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† (Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
    hammer.on('swiperight', () => {
        if (currentPageIdx > 0) {
            currentPageIdx--;
            showPage(pages[currentPageIdx], 'prev');
        }
    });
});

function showPage(pId) {
    currentPageIdx = pages.indexOf(pId);
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙƒÙ„ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-link-custom').forEach(n => n.classList.remove('active'));
    
    const targetPage = document.getElementById('p-' + pId);
    targetPage.classList.add('active');
    document.getElementById('nav-' + pId).classList.add('active');
    
    window.scrollTo(0, 0);
}

// --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (login, logout, render) ---
function login() {
    const code = document.getElementById('auth-code').value.trim();
    if(!code) return;
    rdb.ref('active_stores/'+code).once('value', s => {
        if(s.exists()){ localStorage.setItem('m_taha_sid', code); location.reload(); }
    });
}
if(sid) rdb.ref('active_stores/'+sid).once('value', s => { if(s.exists()) initApp(s.val().name); });

function initApp(name) {
    document.getElementById('auth-screen').classList.add('d-none');
    document.getElementById('main-app').style.display = 'block';
    document.getElementById('store-title').innerText = name;
    rdb.ref('stores_data/'+sid).on('value', ss => { data = ss.val() || { p: [], s: [] }; renderData(); });
}

function logout() { localStorage.clear(); location.reload(); }

function autoPrice() {
    const i = document.getElementById('pos-select').value;
    if(i !== "") document.getElementById('pos-price').value = data.p[i].sell;
}

function filterPOS() {
    const q = document.getElementById('pos-search').value.toLowerCase();
    const sel = document.getElementById('pos-select'); sel.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q)) sel.innerHTML += `<option value="${i}">${p.name} (${p.qty})</option>`;
    });
}

function submitSale() {
    const i = document.getElementById('pos-select').value, q = +document.getElementById('pos-qty').value, pr = +document.getElementById('pos-price').value;
    if(i === "" || q <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù");
    const today = new Date().toLocaleDateString('ar-EG');
    if(!data.s) data.s = [];
    data.s.push({ n: data.p[i].name, q: q, t: q*pr, c: q*data.p[i].buy, d: today });
    data.p[i].qty -= q;
    rdb.ref('stores_data/'+sid).set(data).then(() => alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…"));
}

function saveToStock() {
    const n = document.getElementById('st-name').value, q = +document.getElementById('st-qty').value, b = +document.getElementById('st-buy').value, s = +document.getElementById('st-sell').value;
    if(!n) return;
    if(!data.p) data.p = [];
    data.p.push({ name:n, qty:q, buy:b, sell:s });
    rdb.ref('stores_data/'+sid).set(data).then(() => {
        document.getElementById('st-name').value = "";
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† ğŸ“¦");
    });
}

function renderData() {
    let pft = 0, stValue = 0;
    const today = new Date().toLocaleDateString('ar-EG');
    const sBody = document.getElementById('sales-table-body'); sBody.innerHTML = "";
    (data.s || []).forEach(x => { if(x.d === today) { pft += (x.t - x.c); sBody.innerHTML += `<tr><td>${x.n}</td><td class='text-end'>${x.q} Ù‚Ø·Ø¹Ø©</td></tr>`; } });
    (data.p || []).forEach(p => { stValue += (p.buy * p.qty); });
    document.getElementById('stat-profit').innerText = pft.toLocaleString();
    document.getElementById('stat-stock-val').innerText = stValue.toLocaleString();
    filterPOS();
}
</script>
</body>
</html>
