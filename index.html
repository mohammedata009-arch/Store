<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯ÙƒØ§ÙƒÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„ | Ù…Ø­Ù…Ø¯ Ø·Ù‡</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --info:#3498db; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:80px; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background:white; border-radius:15px; padding:15px; margin-bottom:15px; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:8px; box-sizing:border-box; font-family:'Cairo'; font-size: 16px; }
        .main-btn { width:100%; padding:15px; border:none; border-radius:10px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; margin-top:10px; font-family:'Cairo'; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #lock-screen { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; padding:20px; text-align:center; box-sizing:border-box; }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-tabs { display: flex; justify-content: space-around; background: white; padding: 10px 0; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #ddd; z-index: 1000; }
        .tab-btn { border: none; background: none; font-family: 'Cairo'; cursor: pointer; color: #7f8c8d; font-size: 12px; }
        .tab-btn.active { color: var(--primary); font-weight: bold; }
        .page { display: none; } .page.active { display: block; }

        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center; }
        .modal-content { background:white; width:90%; max-width:400px; padding:20px; border-radius:20px; overflow-y:auto; }
    </style>
</head>
<body>

<div id="lock-screen" style="display:none;">
    <h2 style="margin-top:100px;">ğŸª Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯ÙƒØ§ÙƒÙŠÙ†</h2>
    <p>Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¯ÙƒØ§Ù†Ùƒ</p>
    <input type="password" id="access-code" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ" style="text-align:center; letter-spacing:5px;">
    <button class="main-btn" onclick="verifyAccess()">ØªÙØ¹ÙŠÙ„ ÙˆØ¯Ø®ÙˆÙ„ ğŸš€</button>
</div>

<div id="main-app" class="container">
    <div id="home-page" class="page active">
        <div class="card" style="background:var(--primary); color:white; text-align:center;">
            <h3 id="store-title">Ø¯ÙƒØ§Ù†Ùƒ</h3>
            <p>Ø£Ø±Ø¨Ø§Ø­Ùƒ Ø§Ù„ØµØ§ÙÙŠØ© Ø§Ù„ÙŠÙˆÙ…</p>
            <h1 id="profit-display">0</h1>
        </div>
        <h4>ğŸ–¨ï¸ Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø·Ø¨Ø§Ø¹Ø© PDF)</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="main-btn" style="background:var(--secondary)" onclick="openReport('stock')">Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†</button>
            <button class="main-btn" style="background:var(--secondary)" onclick="openReport('debt')">Ø§Ù„Ø¯ÙŠÙˆÙ†</button>
            <button class="main-btn" style="background:var(--info); grid-column:span 2;" onclick="openReport('full')">ØªÙ‚Ø±ÙŠØ± Ø®ØªØ§Ù…ÙŠ Ø´Ø§Ù…Ù„</button>
        </div>
    </div>

    <div id="sell-page" class="page">
        <div class="card">
            <h4>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h4>
            <select id="p-select" onchange="updatePrice()"><option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option></select>
            <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <input type="number" id="p-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" readonly>
            <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ ğŸ–¨ï¸</button>
        </div>
        <div class="card">
            <h4>ğŸ““ ØªØ³Ø¬ÙŠÙ„ Ø¯ÙŠÙ†</h4>
            <input type="text" id="d-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
            <input type="number" id="d-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <button class="main-btn" style="background:var(--danger);" onclick="addDebt()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙŠÙ†</button>
        </div>
    </div>

    <div id="stock-page" class="page">
        <div class="card">
            <h4>ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²Ù†</h4>
            <input type="text" id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
            <input type="number" id="in-buy" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
            <input type="number" id="in-sell" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
            <input type="number" id="in-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button class="main-btn" onclick="saveToStock()">Ø­ÙØ¸ Ø¨Ø¶Ø§Ø¹Ø©</button>
        </div>
        <div class="card">
            <h4>ğŸ’¸ ØµØ±Ù Ù…ØµØ±ÙˆÙ</h4>
            <input type="text" id="exp-name" placeholder="Ø¨ÙŠØ§Ù† (ÙƒÙ‡Ø±Ø¨Ø§Ø¡ØŒ Ù†ÙØ§ÙŠØ§Øª...)">
            <input type="number" id="exp-amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <button class="main-btn" style="background:var(--secondary)" onclick="saveExp()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        </div>
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <div id="print-area">
            <center><h2 id="m-title"></h2><hr><div id="m-body"></div></center>
        </div>
        <button class="main-btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="main-btn" style="background:gray" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<nav class="nav-tabs">
    <button class="tab-btn active" onclick="tab('home-page', this)">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="tab-btn" onclick="tab('sell-page', this)">ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    <button class="tab-btn" onclick="tab('stock-page', this)">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</button>
</nav>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = { 
        apiKey: "Ø¶Ø¹_Ù‡Ù†Ø§_Ù…ÙØªØ§Ø­Ùƒ", 
        databaseURL: "Ø±Ø§Ø¨Ø·_Ù‚Ø§Ø¹Ø¯ØªÙƒ", 
        projectId: "Ù…Ø¹Ø±Ù_Ù…Ø´Ø±ÙˆØ¹Ùƒ" 
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    let db = {
        p: JSON.parse(localStorage.getItem('p')) || [],
        s: JSON.parse(localStorage.getItem('s')) || [],
        d: JSON.parse(localStorage.getItem('d')) || [],
        e: JSON.parse(localStorage.getItem('e')) || []
    };

    // 3. Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ù€ GPS
    function verifyAccess() {
        const code = document.getElementById('access-code').value;
        database.ref('activations/' + code).once('value', snap => {
            if(snap.exists()){
                localStorage.setItem('active', 'true');
                localStorage.setItem('storeId', code);
                localStorage.setItem('storeName', snap.val().name);
                location.reload();
            } else { alert("Ø±Ù…Ø² Ø®Ø·Ø£!"); }
        });
    }

    if(!localStorage.getItem('active')) {
        document.getElementById('lock-screen').style.display = 'block';
    } else {
        document.getElementById('store-title').innerText = localStorage.getItem('storeName');
        getGPS();
    }

    function getGPS() {
        navigator.geolocation.getCurrentPosition(pos => {
            const data = { lat: pos.coords.latitude, lng: pos.coords.longitude, time: new Date().toLocaleString() };
            database.ref('stores/' + localStorage.getItem('storeId') + '/location').set(data);
        });
    }

    // 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ©
    function tab(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
        render();
    }

    function saveToStock() {
        const name = document.getElementById('in-name').value;
        const buy = +document.getElementById('in-buy').value;
        const sell = +document.getElementById('in-sell').value;
        const qty = +document.getElementById('in-qty').value;
        if(!name || qty <=0) return;
        db.p.push({name, buy, sell, qty});
        sync();
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù");
    }

    function doSale() {
        const i = document.getElementById('p-select').value;
        const q = +document.getElementById('p-qty').value;
        if(i==="" || q<=0) return;
        let item = db.p[i];
        if(item.qty < q) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ©");
        
        const total = q * item.sell;
        const profit = total - (q * item.buy);
        db.s.push({t: total, p: profit, date: new Date().toLocaleDateString()});
        item.qty -= q;
        sync();
        showModal("ÙØ§ØªÙˆØ±Ø© Ø²Ø¨ÙˆÙ†", `<h3>Ø§Ù„Ù…Ø¨Ù„Øº: ${total} Ø¬</h3>`);
    }

    function saveExp() {
        const name = document.getElementById('exp-name').value;
        const amt = +document.getElementById('exp-amt').value;
        if(!name || amt <=0) return;
        db.e.push({name, amt, date: new Date().toLocaleDateString()});
        sync();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    function addDebt() {
        const name = document.getElementById('d-name').value;
        const amt = +document.getElementById('d-amt').value;
        if(!name || amt <=0) return;
        db.d.push({name, amt, date: new Date().toLocaleDateString()});
        sync();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
    }

    function sync() {
        localStorage.setItem('p', JSON.stringify(db.p));
        localStorage.setItem('s', JSON.stringify(db.s));
        localStorage.setItem('d', JSON.stringify(db.d));
        localStorage.setItem('e', JSON.stringify(db.e));
        // Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø­Ù…Ø¯ Ø·Ù‡)
        database.ref('stores/' + localStorage.getItem('storeId') + '/inventory').set({available: db.p});
        render();
    }

    function openReport(type) {
        let t = ""; let b = "";
        if(type==='stock') { t="Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†"; b=db.p.map(x=>`<div>${x.name}: ${x.qty}</div>`).join(''); }
        if(type==='debt') { t="Ø§Ù„Ø¯ÙŠÙˆÙ†"; b=db.d.map(x=>`<div>${x.name}: ${x.amt} Ø¬</div>`).join(''); }
        if(type==='full') {
            t="ØªÙ‚Ø±ÙŠØ± Ø®ØªØ§Ù…ÙŠ";
            let p = db.s.reduce((a,b)=>a+b.p,0) - db.e.reduce((a,b)=>a+b.amt,0);
            b = `<h2>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${p} Ø¬</h2>`;
        }
        showModal(t, b);
    }

    function showModal(t, b) {
        document.getElementById('m-title').innerText = t;
        document.getElementById('m-body').innerHTML = b;
        document.getElementById('modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modal').style.display='none'; }

    function updatePrice() {
        const i = document.getElementById('p-select').value;
        if(i!=="") document.getElementById('p-price').value = db.p[i].sell;
    }

    function render() {
        const sel = document.getElementById('p-select');
        sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØµÙ†Ù --</option>';
        db.p.forEach((x,i) => { if(x.qty>0) sel.innerHTML+=`<option value="${i}">${x.name} (${x.qty})</option>`; });
        
        const today = new Date().toLocaleDateString();
        const p = db.s.filter(x=>x.date===today).reduce((a,b)=>a+b.p,0);
        const e = db.e.filter(x=>x.date===today).reduce((a,b)=>a+b.amt,0);
        document.getElementById('profit-display').innerText = (p - e) + " Ø¬";
    }
    render();
</script>
</body>
</html>
