<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… M-TAHA Ø§Ù„Ø°ÙƒÙŠ</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --warning:#f39c12; --info:#3498db; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:90px; color: var(--secondary); overflow-x: hidden; }
        #lock-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .lock-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .container { padding:15px; max-width:600px; margin:auto; }
        .page { display:none; animation:fadeIn 0.3s ease; }
        .page.active { display:block; }
        @keyframes fadeIn { from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);} }
        .card { background:white; border-radius:18px; padding:18px; box-shadow:0 5px 15px rgba(0,0,0,0.04); margin-bottom:15px; border: 1px solid #edf2f7; }
        header { background: var(--secondary); color: white; padding: 25px 20px; text-align: center; border-radius: 0 0 30px 30px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        label { display: block; font-weight: 700; margin: 10px 0 5px; font-size: 13px; }
        input, select { width:100%; padding:14px; border:1.5px solid #eee; border-radius:12px; font-size:16px; outline:none; font-family:'Cairo'; background: #fcfcfc; box-sizing: border-box; }
        input:focus { border-color: var(--primary); background: white; }
        .main-btn { width:100%; padding:15px; border:none; border-radius:12px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; font-size:16px; margin-top:10px; transition: 0.3s; }
        .main-btn:active { transform: scale(0.96); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: -45px; padding: 0 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 18px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-bottom: 4px solid var(--primary); }
        .stat-card b { font-size: 18px; color: var(--primary); display: block; }
        .stat-card span { font-size: 11px; color: #7f8c8d; font-weight: bold; }
        .list-item { display:flex; justify-content:space-between; align-items:center; padding:12px; background: #f8faf9; border-radius: 12px; margin-bottom: 8px; border: 1px solid #eee; }
        .bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px 0; box-shadow:0 -5px 20px rgba(0,0,0,0.05); }
        .nav-item { border:none; background:none; color:#bdc3c7; font-size:12px; cursor:pointer; flex:1; font-family:'Cairo'; }
        .nav-item.active { color:var(--primary); font-weight: 900; }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div id="lock-screen">
    <div class="lock-card">
        <h2 style="color:var(--primary);">M-TAHA ERP</h2>
        <div id="reg-form">
            <p>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØ¬Ø± Ù„Ù„ØªÙØ¹ÙŠÙ„</p>
            <input type="text" id="reg-sid" placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØ¬Ø± (Ù…Ø«Ù„Ø§Ù‹: shop101)" style="margin-bottom:10px;">
            <input type="text" id="reg-name" placeholder="Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ù…ØªØ¬Ø±">
            <button class="main-btn" onclick="requestActivation()">Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ ğŸ”‘</button>
        </div>
        <div id="wait-msg" style="display:none;">
            <div style="font-size: 40px;">â³</div>
            <h3>Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ù…Ø­Ù…Ø¯ Ø·Ù‡</h3>
            <p>Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
            <button class="main-btn" style="background:var(--secondary)" onclick="location.reload()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
        </div>
    </div>
</div>

<div id="app-content" style="display:none;">
    <header><h3 id="display-store-name" style="margin:0;">Ù…ØªØ¬Ø±ÙŠ</h3></header>
    <div class="stat-grid">
        <div class="stat-card"><span>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span><b id="p-total">0</b></div>
        <div class="stat-card"><span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span><b id="s-total">0</b></div>
    </div>
    <div class="container">
        <div id="home" class="page active">
            <div class="card" style="border-right: 5px solid var(--danger);">
                <h4 style="color:var(--danger); margin:0;">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h4>
                <div id="low-list"></div>
            </div>
        </div>
        <div id="sell" class="page">
            <div class="card">
                <h3>ğŸ§¾ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</h3>
                <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù..." onkeyup="search()">
                <select id="p-select" size="3" onchange="updateSellPrice()" style="margin-top:10px;"></select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                    <input type="number" id="p-price-edit" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                </div>
                <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
            </div>
        </div>
        <div id="stock" class="page">
            <div class="card">
                <h3>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¹Ø©</h3>
                <input id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input id="in-buy" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
                    <input id="in-sell" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
                </div>
                <input id="in-q" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" style="margin-top:10px;">
                <button class="main-btn" onclick="saveStock()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</button>
            </div>
            <div id="full-inventory"></div>
        </div>
    </div>
    <div class="bottom-nav">
        <button class="nav-item active" onclick="tab('home',this)">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-item" onclick="tab('sell',this)">ğŸ§¾<br>Ø§Ù„Ø¨ÙŠØ¹</button>
        <button class="nav-item" onclick="tab('stock',this)">ğŸ“¦<br>Ø§Ù„Ù…Ø®Ø²Ù†</button>
        <button class="nav-item" onclick="if(confirm('Ø®Ø±ÙˆØ¬ØŸ')){localStorage.clear();location.reload();}">ğŸšª<br>Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
// --- Ø±Ø§Ø¨Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙŠØ§ Ù…Ø­Ù…Ø¯ Ø·Ù‡ ---
const firebaseConfig = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let sid = localStorage.getItem('m_taha_sid');
let storeData = { p: [], s: [] };

if(sid) {
    rdb.ref('requests/'+sid).on('value', s => {
        const d = s.val();
        if(d && d.status === 'active') {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('display-store-name').innerText = d.name;
            rdb.ref('stores/'+sid).on('value', ss => { storeData = ss.val() || { p: [], s: [] }; render(); });
        } else {
            document.getElementById('reg-form').style.display = 'none';
            document.getElementById('wait-msg').style.display = 'block';
        }
    });
}

function requestActivation() {
    const id = document.getElementById('reg-sid').value.trim();
    const nm = document.getElementById('reg-name').value.trim();
    if(!id || !nm) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    rdb.ref('requests/'+id).set({ name: nm, status: 'pending' }).then(() => {
        localStorage.setItem('m_taha_sid', id);
        location.reload();
    });
}

function sync() { rdb.ref('stores/'+sid).set(storeData); }

function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function search() {
    let q = document.getElementById('search').value.toLowerCase();
    let s = document.getElementById('p-select'); s.innerHTML = "";
    (storeData.p || []).forEach((item, i) => {
        if(item.name.toLowerCase().includes(q)) s.innerHTML += `<option value="${i}">${item.name} (${item.qty})</option>`;
    });
}

function updateSellPrice() {
    let i = document.getElementById('p-select').value;
    if(i !== "") document.getElementById('p-price-edit').value = storeData.p[i].sell;
}

function doSale() {
    let i = document.getElementById('p-select').value, q = +document.getElementById('p-qty').value, price = +document.getElementById('p-price-edit').value;
    if(i==="" || q<=0) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
    if(storeData.p[i].qty < q) return alert("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ");
    if(!storeData.s) storeData.s = [];
    storeData.s.push({ n: storeData.p[i].name, q, t: q*price, c: q*storeData.p[i].buy });
    storeData.p[i].qty -= q;
    sync();
    document.getElementById('p-qty').value = "";
}

function saveStock() {
    let n = document.getElementById('in-name').value, b = +document.getElementById('in-buy').value, s = +document.getElementById('in-sell').value, q = +document.getElementById('in-q').value;
    if(!n || isNaN(b)) return alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");
    if(!storeData.p) storeData.p = [];
    storeData.p.push({name:n, buy:b, sell:s, qty:q});
    sync();
    document.getElementById('in-name').value = ""; document.getElementById('in-buy').value = ""; document.getElementById('in-sell').value = ""; document.getElementById('in-q').value = "";
}

function render() {
    let ts=0, tc=0;
    (storeData.s || []).forEach(x => { ts += x.t; tc += x.c; });
    document.getElementById('s-total').innerText = ts.toLocaleString();
    document.getElementById('p-total').innerText = (ts-tc).toLocaleString();
    let lowDiv = document.getElementById('low-list'); lowDiv.innerHTML = "";
    (storeData.p || []).forEach(p => { if(p.qty <= 5) lowDiv.innerHTML += `<div class="list-item"><span>${p.name}</span><b class="badge" style="background:var(--warning)">${p.qty}</b></div>`; });
    let invDiv = document.getElementById('full-inventory'); invDiv.innerHTML = "";
    (storeData.p || []).forEach((p, i) => {
        invDiv.innerHTML += `<div class="card"><div class="list-item"><b>${p.name}</b><span>Ø§Ù„ÙƒÙ…ÙŠØ©: ${p.qty}</span></div>
        <button onclick="if(confirm('Ø­Ø°ÙØŸ')){storeData.p.splice(${i},1);sync();}" style="color:var(--danger); background:none; border:none; width:100%; cursor:pointer;">âŒ Ø­Ø°Ù Ø§Ù„ØµÙ†Ù</button></div>`;
    });
}
</script>
</body>
</html>
