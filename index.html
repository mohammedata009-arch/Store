<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… M-TAHA Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --warning:#f39c12; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:90px; }
        .container { padding:15px; max-width:600px; margin:auto; }
        .page { display:none; } .page.active { display:block; }
        .card { background:white; border-radius:15px; padding:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05); margin-bottom:15px; }
        header { background: var(--secondary); color: white; padding: 20px; text-align: center; border-radius: 0 0 25px 25px; position: relative; }
        input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; margin-top:5px; font-family:'Cairo'; box-sizing: border-box; }
        .main-btn { width:100%; padding:12px; border:none; border-radius:10px; background:var(--primary); color:white; font-weight:bold; cursor:pointer; margin-top:10px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: -30px; padding: 0 15px; }
        .stat-card { background: white; padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .stat-card b { color: var(--primary); font-size: 16px; }
        .bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:10px 0; box-shadow:0 -5px 15px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { border:none; background:none; color:#bdc3c7; font-size:12px; cursor:pointer; font-family:'Cairo'; }
        .nav-item.active { color:var(--primary); font-weight:bold; }
        .logout-btn { position: absolute; left: 10px; top: 10px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; }
        @media print { .bottom-nav, .main-btn, header, input, select, .no-print { display: none !important; } .page { display: block !important; } }
    </style>
</head>
<body>

<div id="lock-screen" style="display:flex; position:fixed; inset:0; background:var(--bg); z-index:9999; align-items:center; justify-content:center; text-align:center;">
    <div class="card" style="width: 85%;">
        <h2 style="color:var(--secondary)">Ù†Ø¸Ø§Ù… M-TAHA</h2>
        <p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</p>
        <input type="text" id="reg-sid" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù (ID)">
        <button class="main-btn" onclick="checkAuth()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<div id="app-content" style="display:none;">
    <header>
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h3 id="display-store-name">ØªØ­Ù…ÙŠÙ„...</h3>
    </header>
    
    <div class="stat-grid">
        <div class="stat-card"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span><br><b id="s-total">0</b></div>
        <div class="stat-card"><span>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span><br><b id="p-total">0</b></div>
    </div>

    <div class="container">
        <div id="home" class="page active">
            <div class="card">
                <h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</h4>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <b id="e-total" style="color:var(--danger)">0</b></p>
                <p>Ø§Ù„Ø±Ø¨Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <b id="final-profit" style="color:var(--primary)">0</b></p>
                <p>Ù‚ÙŠÙ…Ø© Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø®Ø²Ù†: <b id="stock-val">0</b></p>
            </div>
            <button class="main-btn" style="background:var(--warning)" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
            <button class="main-btn" style="background:var(--danger)" onclick="dailyReset()">ğŸ§¹ ØªØµÙÙŠØ± Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div id="sell" class="page">
            <div class="card">
                <h3>ğŸ§¾ Ø¹Ù…Ù„ÙŠØ© Ø¨ÙŠØ¹</h3>
                <input type="text" id="search" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="search()">
                <select id="p-select" size="3" onchange="if(this.value!=='') document.getElementById('p-price-edit').value = storeData.p[this.value].sell"></select>
                <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <input type="number" id="p-price-edit" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ âœ…</button>
            </div>
        </div>

        <div id="stock" class="page">
            <div class="card">
                <h3>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¹Ø©</h3>
                <input id="in-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
                <input id="in-buy" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
                <input id="in-sell" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
                <input id="in-q" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <button class="main-btn" onclick="saveStock()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</button>
            </div>
            <div id="full-inventory"></div>
        </div>

        <div id="expenses" class="page">
            <div class="card">
                <h3>ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª</h3>
                <input id="exp-name" placeholder="Ø¨ÙŠØ§Ù† Ø§Ù„ØµØ±Ù">
                <input id="exp-amt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="main-btn" style="background:var(--danger)" onclick="addExp()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±Ù</button>
            </div>
            <div id="exp-list"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="tab('home',this)">ğŸ“Š Ø­Ø³Ø§Ø¨Ø§Øª</button>
        <button class="nav-item" onclick="tab('sell',this)">ğŸ§¾ Ø¨ÙŠØ¹</button>
        <button class="nav-item" onclick="tab('stock',this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
        <button class="nav-item" onclick="tab('expenses',this)">ğŸ’¸ Ù…ØµØ±ÙˆÙ</button>
    </div>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø±Ø¨Ø·
const firebaseConfig = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let sid = localStorage.getItem('m_taha_sid');
let storeData = { p: [], s: [], e: [] };

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function checkAuth() {
    let inputId = document.getElementById('reg-sid').value.trim();
    if(!inputId) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù Ø£ÙˆÙ„Ø§Ù‹");
    
    rdb.ref('requests/' + inputId).once('value', s => {
        if(s.exists() && s.val().status === 'active') {
            localStorage.setItem('m_taha_sid', inputId);
            location.reload();
        } else {
            alert("Ø§Ù„Ù…Ø¹Ø±Ù ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø£Ùˆ ØºÙŠØ± Ù…ÙØ¹Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");
        }
    });
}

function logout() { localStorage.removeItem('m_taha_sid'); location.reload(); }

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª
if(sid) {
    rdb.ref('requests/' + sid).on('value', s => {
        if(s.exists() && s.val().status === 'active') {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('display-store-name').innerText = "Ù…ØªØ¬Ø±: " + s.val().name;
            
            rdb.ref('stores/' + sid).on('value', ss => { 
                storeData = ss.val() || { p: [], s: [], e: [] }; 
                render(); 
            });
        } else {
            logout();
        }
    });
}

// Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… (Ø¨Ù‚Øª ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚)
function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function search() {
    let q = document.getElementById('search').value.toLowerCase();
    let s = document.getElementById('p-select'); s.innerHTML = "";
    (storeData.p || []).forEach((p, i) => { 
        if(p.name.toLowerCase().includes(q)) s.innerHTML += `<option value="${i}">${p.name} (Ù…ØªÙˆÙØ±: ${p.qty})</option>`; 
    });
}

function doSale() {
    let i = document.getElementById('p-select').value, q = +document.getElementById('p-qty').value, pr = +document.getElementById('p-price-edit').value;
    if(i==="" || q<=0 || storeData.p[i].qty < q) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„ØµÙ†Ù");
    if(!storeData.s) storeData.s = [];
    storeData.s.push({ n: storeData.p[i].name, q, t: q*pr, c: q*storeData.p[i].buy });
    storeData.p[i].qty -= q;
    sync();
}

function saveStock() {
    let n = document.getElementById('in-name').value, b = +document.getElementById('in-buy').value, s = +document.getElementById('in-sell').value, q = +document.getElementById('in-q').value;
    if(!n || q <= 0) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù");
    if(!storeData.p) storeData.p = [];
    storeData.p.push({name:n, buy:b, sell:s, qty:q});
    sync();
    alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†");
}

function addExp() {
    let n = document.getElementById('exp-name').value, a = +document.getElementById('exp-amt').value;
    if(!n || a<=0) return;
    if(!storeData.e) storeData.e = [];
    storeData.e.push({n, a});
    sync();
}

function dailyReset() {
    if(confirm("Ø³ÙŠØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙÙ‚Ø·ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        storeData.s = [];
        storeData.e = [];
        sync();
    }
}

function sync() { rdb.ref('stores/' + sid).set(storeData); }

function render() {
    let ts=0, tc=0, te=0, sv=0;
    (storeData.s || []).forEach(x => { ts += x.t; tc += x.c; });
    (storeData.e || []).forEach(x => { te += x.a; });
    (storeData.p || []).forEach(x => { sv += (x.qty * x.buy); });

    document.getElementById('s-total').innerText = ts.toLocaleString();
    document.getElementById('p-total').innerText = (ts - tc).toLocaleString();
    document.getElementById('e-total').innerText = te.toLocaleString();
    document.getElementById('final-profit').innerText = ((ts - tc) - te).toLocaleString();
    document.getElementById('stock-val').innerText = sv.toLocaleString();

    let invDiv = document.getElementById('full-inventory'); invDiv.innerHTML = "<h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²Ù†:</h4>";
    (storeData.p || []).forEach((p, i) => {
        invDiv.innerHTML += `<div class="card">${p.name} - ÙƒÙ…ÙŠØ©: ${p.qty} <button onclick="if(confirm('Ø­Ø°ÙØŸ')){storeData.p.splice(${i},1);sync();}" style="color:red; float:left; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></div>`;
    });

    let eDiv = document.getElementById('exp-list'); eDiv.innerHTML = "<h4>Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</h4>";
    (storeData.e || []).forEach(x => { eDiv.innerHTML += `<div>â€¢ ${x.n}: ${x.a} Ø¬</div>`; });
}
</script>
</body>
</html>
