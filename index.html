<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù‚Ø§Ù„Ø© M-TAHA</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --p: #0984e3; --red: #d63031; --green: #00b894; --gold: #f1c40f; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: #f4f7f6; margin: 0; padding-bottom: 70px; }
        #news-bar { background: var(--gold); padding: 10px; text-align: center; font-weight: bold; display: none; }
        header { background: var(--p); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; }
        .container { padding: 15px; max-width: 500px; margin: auto; }
        .v-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .v-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; text-align: center; font-size: 16px; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; }
        .wa-btn { background: #25D366; color: white; padding: 5px 10px; border-radius: 8px; text-decoration: none; font-size: 12px; display: inline-block; }
        #reg-screen { position: fixed; inset: 0; background: white; z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #ddd; }
        .nav-link { background: none; border: none; color: #636e72; font-size: 12px; font-weight: bold; cursor: pointer; }
        .nav-link.active { color: var(--p); }
        .page { display: none; } .page.active { display: block; }
        .low-stk { color: var(--red); font-weight: bold; }
    </style>
</head>
<body>

<div id="news-bar"></div>

<div id="reg-screen">
    <div class="v-card" style="width: 100%; text-align: center;">
        <h2 style="color:var(--p)">ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ¬Ø± Ø¬Ø¯ÙŠØ¯</h2>
        <input type="text" id="reg-name" class="v-input" placeholder="Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©">
        <input type="number" id="reg-phone" class="v-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button class="btn" style="background:var(--p)" onclick="requestAccess()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„</button>
        <p id="reg-msg" style="margin-top:10px; font-size:12px;"></p>
    </div>
</div>

<header id="app-head" style="display:none">
    <h3 id="store-title">Ù…ØªØ¬Ø±ÙŠ</h3>
    <div style="font-size:12px">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…: <span id="st-p">0</span> | Ø¯ÙŠÙˆÙ†: <span id="st-d">0</span></div>
</header>

<div class="container" id="app-body" style="display:none">
    <div id="p-sale" class="page active">
        <div class="v-card">
            <h4>ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§Øª</h4>
            <select id="s-item" class="v-input"></select>
            <input type="number" id="s-qty" class="v-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <select id="s-debtor" class="v-input"><option value="">-- ÙƒØ§Ø´ --</option></select>
            <button class="btn" style="background:var(--green)" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
        </div>
    </div>

    <div id="p-stk" class="page">
        <div class="v-card">
            <h4>ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</h4>
            <input type="text" id="i-n" class="v-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input type="number" id="i-b" class="v-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
            <input type="number" id="i-s" class="v-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
            <input type="number" id="i-q" class="v-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button class="btn" style="background:var(--p)" onclick="addStk()">Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬</button>
        </div>
        <div id="stk-list"></div>
    </div>

    <div id="p-deb" class="page">
        <div class="v-card">
            <h4>ğŸ““ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠÙ†</h4>
            <input type="text" id="d-n" class="v-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
            <input type="number" id="d-p" class="v-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
            <button class="btn" style="background:var(--p)" onclick="addDeb()">Ø¥Ø¶Ø§ÙØ© Ø²Ø¨ÙˆÙ†</button>
        </div>
        <div id="deb-list"></div>
    </div>
</div>

<nav id="app-nav" style="display:none">
    <button class="nav-link active" onclick="tab('p-sale',this)">ğŸ  Ø¨ÙŠØ¹</button>
    <button class="nav-link" onclick="tab('p-stk',this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
    <button class="nav-link" onclick="tab('p-deb',this)">ğŸ““ Ø¯ÙŠÙˆÙ†</button>
    <button class="nav-link" style="color:var(--red)" onclick="localStorage.clear(); location.reload();">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<script>
    const cfg = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
    firebase.initializeApp(cfg); const db = firebase.database();
    let sid = localStorage.getItem('sid'), storeData = null;

    if(!sid) { document.getElementById('reg-screen').style.display='flex'; }
    else { checkStatus(); }

    function requestAccess() {
        const n = document.getElementById('reg-name').value, p = document.getElementById('reg-phone').value;
        if(!n || !p) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const id = "S_" + Date.now();
        db.ref('requests/'+id).set({name:n, phone:p, status:'pending'}).then(()=>{
            localStorage.setItem('sid', id); location.reload();
        });
    }

    function checkStatus() {
        db.ref('requests/'+sid).on('value', s => {
            const d = s.val();
            if(d && d.status === 'active') {
                document.getElementById('reg-screen').style.display='none';
                document.getElementById('app-head').style.display='block';
                document.getElementById('app-body').style.display='block';
                document.getElementById('app-nav').style.display='flex';
                initApp();
            } else {
                document.getElementById('reg-screen').style.display='flex';
                document.getElementById('reg-msg').innerText = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙØ¹ÙŠÙ„ Ù…Ø­Ù…Ø¯ Ø·Ù‡...";
            }
        });
        db.ref('admin_news').on('value', s => {
            if(s.val()){ document.getElementById('news-bar').innerText = s.val(); document.getElementById('news-bar').style.display='block'; }
        });
    }

    function initApp() {
        db.ref('stores/'+sid).on('value', s => {
            storeData = s.val() || {inventory:[], sales:[], debtors:[]};
            updateUI();
        });
    }

    function updateUI() {
        const si = document.getElementById('s-item'); si.innerHTML = '';
        storeData.inventory.forEach((x,i) => si.innerHTML += `<option value="${i}">${x.name} (${x.qty})</option>`);
        
        const sd = document.getElementById('s-debtor'); sd.innerHTML = '<option value="">-- ÙƒØ§Ø´ --</option>';
        storeData.debtors.forEach((x,i) => sd.innerHTML += `<option value="${i}">${x.name}</option>`);

        let pToday = 0, dTotal = 0;
        storeData.sales.forEach(x => pToday += x.profit);
        storeData.debtors.forEach(x => dTotal += x.balance);
        document.getElementById('st-p').innerText = pToday;
        document.getElementById('st-d').innerText = dTotal;

        const sl = document.getElementById('stk-list'); sl.innerHTML = '';
        storeData.inventory.forEach((x,i) => sl.innerHTML += `<div class="v-card ${x.qty<5?'low-stk':''}">
            ${x.name} | ÙƒÙ…ÙŠØ©: ${x.qty} | Ø³Ø¹Ø±: ${x.sell}
            <button onclick="delItem('inventory',${i})" style="color:red; background:none; border:none; float:left">Ø­Ø°Ù</button>
        </div>`);

        const dl = document.getElementById('deb-list'); dl.innerHTML = '';
        storeData.debtors.forEach((x,i) => dl.innerHTML += `<div class="v-card">
            <b>${x.name}</b> | Ø§Ù„Ù…Ø¨Ù„Øº: ${x.balance} Ø¬.Ø³ <br>
            <a class="wa-btn" href="https://wa.me/249${x.phone}">ÙˆØ§ØªØ³Ø§Ø¨</a>
            <button onclick="clearDeb(${i})" style="float:left">ØªØ³Ø¯ÙŠØ¯</button>
        </div>`);
    }

    function addStk() {
        const n=document.getElementById('i-n').value, b=parseFloat(document.getElementById('i-b').value), s=parseFloat(document.getElementById('i-s').value), q=parseInt(document.getElementById('i-q').value);
        if(!n || isNaN(b)) return;
        if(!storeData.inventory) storeData.inventory = [];
        storeData.inventory.push({name:n, buy:b, sell:s, qty:q});
        db.ref('stores/'+sid+'/inventory').set(storeData.inventory);
    }

    function addDeb() {
        const n=document.getElementById('d-n').value, p=document.getElementById('d-p').value;
        if(!n || !p) return;
        if(!storeData.debtors) storeData.debtors = [];
        storeData.debtors.push({name:n, phone:p, balance:0});
        db.ref('stores/'+sid+'/debtors').set(storeData.debtors);
    }

    function doSale() {
        const idx=document.getElementById('s-item').value, q=parseInt(document.getElementById('s-qty').value), dIdx=document.getElementById('s-debtor').value;
        if(idx==="" || isNaN(q)) return;
        let itm = storeData.inventory[idx];
        if(itm.qty < q) return alert("Ø§Ù„Ù…Ø®Ø²Ù† Ù„Ø§ ÙŠÙƒÙÙŠ");
        itm.qty -= q;
        const profit = (itm.sell - itm.buy) * q, total = itm.sell * q;
        if(dIdx !== "") { storeData.debtors[dIdx].balance += total; }
        else { if(!storeData.sales) storeData.sales = []; storeData.sales.push({profit, total}); }
        db.ref('stores/'+sid).set(storeData);
    }

    function clearDeb(i) { if(confirm("ØªØ³Ø¯ÙŠØ¯ ÙƒØ§Ù…Ù„ØŸ")) { storeData.debtors[i].balance = 0; db.ref('stores/'+sid+'/debtors').set(storeData.debtors); }}
    function delItem(path, i) { if(confirm("Ø­Ø°ÙØŸ")) { storeData[path].splice(i,1); db.ref('stores/'+sid+'/'+path).set(storeData[path]); }}
    function tab(id, b) {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
        document.getElementById(id).classList.add('active'); b.classList.add('active');
    }
</script>
</body>
</html>
