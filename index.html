<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… M-TAHA Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --warning:#f39c12; --info:#3498db; --purple:#8e44ad; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:100px; color: #333; }
        header { background: var(--secondary); color: white; padding: 15px 15px 45px 15px; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
        .logout-btn { position: absolute; left: 15px; top: 15px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: -30px 15px 0 15px; }
        .stat-card { background: white; padding: 12px; border-radius: 18px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .container { padding: 15px; max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 20px; padding: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 10px; font-family: 'Cairo'; box-sizing: border-box; }
        .main-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        .bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px 0; box-shadow:0 -5px 25px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { border:none; background:none; color:#bdc3c7; font-size: 11px; cursor:pointer; font-family:'Cairo'; }
        .nav-item.active { color:var(--primary); font-weight:900; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f8f9fa; padding: 8px; font-size: 12px; border-bottom: 2px solid #eee; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #f1f1f1; font-size: 13px; }
        .sale-item { border-right: 4px solid var(--primary); margin-bottom: 8px; padding: 10px; background: #f9f9f9; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸšª</button>
    <h3>Ù†Ø¸Ø§Ù… M-TAHA</h3>
</header>

<div class="stat-grid">
    <div class="stat-card"><span>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span><b id="s-total">0</b></div>
    <div class="stat-card"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</span><b id="d-total" style="color:var(--danger)">0</b></div>
</div>

<div class="container">
    <div id="home" class="page active">
        <div class="card">
            <h4>ğŸ§¾ Ø³Ø¬Ù„ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…ÙØµÙ„</h4>
            <div id="sales-list-detailed"></div>
            <button class="main-btn" style="background:var(--danger); margin-top:15px;" onclick="dailyReset()">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
        </div>
    </div>

    <div id="stats" class="page">
        <div class="card">
            <h4>ğŸ“ˆ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù† (Ø§Ù„Ù†ÙˆØ§Ù‚Øµ)</h4>
            <table id="analysis-table">
                <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="analysis-body"></tbody>
            </table>
        </div>
    </div>

    <div id="stock" class="page">
        <div class="card">
            <h3 id="stock-title">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</h3>
            <input id="in-idx" type="hidden">
            <input id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <input id="in-sell" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
            <input id="in-q" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button class="main-btn" id="stock-btn" onclick="saveStock()">Ø­ÙØ¸</button>
        </div>
        <div id="full-inventory"></div>
    </div>

    <div id="sell" class="page">
        <div class="card">
            <h3>ğŸ§¾ Ø¨ÙŠØ¹</h3>
            <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø«..." onkeyup="render()">
            <select id="p-select" size="5"></select>
            <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹</button>
        </div>
    </div>

    <div id="debts" class="page">
        <div class="card">
            <h3>ğŸ“ Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
            <input id="d-name" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input id="d-amt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <button class="main-btn" style="background:var(--purple)" onclick="addDebt()">Ø­ÙØ¸</button>
        </div>
        <div id="debts-list"></div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item active" onclick="tab('home',this)">ğŸ“Š Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    <button class="nav-item" onclick="tab('stats',this)">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¡</button>
    <button class="nav-item" onclick="tab('sell',this)">ğŸ§¾ Ø¨ÙŠØ¹</button>
    <button class="nav-item" onclick="tab('stock',this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
    <button class="nav-item" onclick="tab('debts',this)">ğŸ“ Ø¯ÙŠÙˆÙ†</button>
</div>

<script>
const firebaseConfig = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
let sid = localStorage.getItem('m_taha_sid') || "demo"; 

let storeData = { p: [], s: [], d: [] };
rdb.ref('stores/'+sid).on('value', ss => { storeData = ss.val() || { p: [], s: [], d: [] }; render(); });

function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function saveStock() {
    let n = document.getElementById('in-name').value, q = +document.getElementById('in-q').value, idx = document.getElementById('in-idx').value;
    if(!n) return;
    if(!storeData.p) storeData.p = [];
    let obj = {name:n, sell:+document.getElementById('in-sell').value, qty:q};
    if(idx === "") storeData.p.push(obj); else storeData.p[idx] = obj;
    rdb.ref('stores/'+sid).set(storeData);
    document.getElementById('in-name').value=""; document.getElementById('in-sell').value=""; document.getElementById('in-q').value="";
}

function doSale() {
    let i = document.getElementById('p-select').value, q = +document.getElementById('p-qty').value;
    if(i==="" || q<=0 || storeData.p[i].qty < q) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ©");
    if(!storeData.s) storeData.s = [];
    storeData.s.push({ n: storeData.p[i].name, q: q, t: q*storeData.p[i].sell, d: new Date().toLocaleTimeString('ar-EG') });
    storeData.p[i].qty -= q;
    rdb.ref('stores/'+sid).set(storeData);
    document.getElementById('p-qty').value = "";
}

function addDebt() {
    let n = document.getElementById('d-name').value, a = +document.getElementById('d-amt').value;
    if(!n || a <= 0) return;
    if(!storeData.d) storeData.d = [];
    storeData.d.push({n, a});
    rdb.ref('stores/'+sid).set(storeData);
    document.getElementById('d-name').value=""; document.getElementById('d-amt').value="";
}

function logout() { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.removeItem('m_taha_sid'); window.location.reload(); } }

function render() {
    let ts=0, td=0;
    (storeData.s || []).forEach(x => ts += x.t);
    (storeData.d || []).forEach(x => td += x.a);
    document.getElementById('s-total').innerText = ts + " Ø¬";
    document.getElementById('d-total').innerText = td + " Ø¬";

    // Ø±Ù†Ø¯Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…ÙØµÙ„Ø© (Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ)
    let sl = document.getElementById('sales-list-detailed'); sl.innerHTML = "";
    if(!storeData.s || storeData.s.length === 0) sl.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</p>";
    (storeData.s || []).forEach((s, i) => {
        sl.innerHTML += `<div class="sale-item">
            <b>${s.n}</b> <br> Ø§Ù„ÙƒÙ…ÙŠØ©: ${s.q} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${s.t} Ø¬ <br>
            <small style="color:#888">${s.d}</small>
            <span onclick="if(confirm('Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹ØŸ')){storeData.s.splice(${i},1);rdb.ref('stores/'+sid).set(storeData)}" style="float:left; color:red; cursor:pointer;">âŒ</span>
        </div>`;
    });

    // Ø±Ù†Ø¯Ø± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ
    let ab = document.getElementById('analysis-body'); ab.innerHTML = "";
    (storeData.p || []).forEach(p => {
        let st = p.qty <= 0 ? "Ù…Ù†ØªÙ‡ÙŠ" : (p.qty <= 5 ? "Ù†Ø§Ù‚Øµ" : "Ù…ØªÙˆÙØ±");
        ab.innerHTML += `<tr><td>${p.name}</td><td>${p.qty}</td><td>${st}</td></tr>`;
    });

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙŠØ¹
    let sel = document.getElementById('p-select'); sel.innerHTML = "";
    let q = document.getElementById('search').value.toLowerCase();
    (storeData.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q)) sel.innerHTML += `<option value="${i}">${p.name} (${p.qty})</option>`;
    });

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²Ù†
    let inv = document.getElementById('full-inventory'); inv.innerHTML = "";
    (storeData.p || []).forEach((p, i) => {
        inv.innerHTML += `<div class="card" style="padding:10px; display:flex; justify-content:space-between;">
            <span>${p.name} (${p.qty})</span>
            <span style="color:var(--info)" onclick="document.getElementById('in-idx').value='${i}'; document.getElementById('in-name').value='${p.name}'; document.getElementById('in-sell').value='${p.sell}'; document.getElementById('in-q').value='${p.qty}'; window.scrollTo(0,0);">âœï¸</span>
        </div>`;
    });
}

function dailyReset() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ")) { storeData.s = []; rdb.ref('stores/'+sid).set(storeData); } }
</script>
</body>
</html>
