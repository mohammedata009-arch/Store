<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-TAHA GPS Elite</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #c5a059; --dark: #0a0f1a; --card: #161e2d; --text: #ffffff; }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--dark); color: var(--text); margin: 0; overflow-x: hidden; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ */
        #auth-screen { position: fixed; inset: 0; background: var(--dark); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: var(--card); padding: 30px; border-radius: 25px; border: 1px solid var(--gold); width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        
        .v-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid #2d3748; background: #0a0f1a; color: white; text-align: center; font-size: 16px; }
        .v-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; background: var(--gold); color: #000; font-weight: 900; cursor: pointer; transition: 0.3s; }
        .v-btn:disabled { background: #444; color: #888; }

        header { padding: 40px 20px; text-align: center; background: linear-gradient(to bottom, var(--card), var(--dark)); border-bottom: 1px solid rgba(197, 160, 89, 0.3); }
        .container { padding: 15px; max-width: 500px; margin: auto; display: none; }
        .v-card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); }
        
        nav { position: fixed; bottom: 20px; left: 10px; right: 10px; background: rgba(22, 30, 45, 0.9); backdrop-filter: blur(10px); height: 75px; border-radius: 20px; display: flex; justify-content: space-around; align-items: center; border: 1px solid rgba(197,160,89,0.3); }
        .nav-item { color: #94a3b8; background: none; border: none; font-size: 11px; font-weight: bold; }
        .nav-item.active { color: var(--gold); }
        .page { display: none; } .page.active { display: block; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h2 style="color:var(--gold); margin-bottom:5px;">M-TAHA v2566</h2>
        <p style="font-size:12px; color:#94a3b8; margin-bottom:20px;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ - ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø·Ù„ÙˆØ¨</p>
        
        <input type="text" id="reg-name" class="v-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="number" id="reg-phone" class="v-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="password" id="reg-code" class="v-input" placeholder="ÙƒÙˆØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø©">
        
        <p id="gps-msg" style="font-size:11px; color:#ef4444;">ğŸ“ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <button id="auth-btn" class="v-btn" onclick="registerUser()" disabled>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
    </div>
</div>

<header id="main-h" style="display:none">
    <h1 id="user-display" class="gold-title" style="color:var(--gold); margin:0;">..</h1>
    <small id="loc-status" style="color:#22c55e">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØªØµÙ„</small>
</header>

<div class="container" id="app-content">
    <div id="pg1" class="page active">
        <div class="v-card" style="text-align:center">
            <small>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…ÙŠ</small>
            <h1 id="net-p" style="color:var(--gold); font-size:48px; margin:10px 0;">0</h1>
            <div style="display:flex; justify-content:space-around; border-top:1px solid #334155; pt:15px;">
                <span>ÙƒØ§Ø´: <b id="v-s" style="color:#22c55e">0</b></span>
                <span>Ø¯ÙŠÙˆÙ†: <b id="v-d" style="color:#ef4444">0</b></span>
            </div>
        </div>
    </div>
</div>

<nav id="main-n" style="display:none">
    <button class="nav-item active" onclick="tab('pg1',this)">ğŸ“Š Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button class="nav-item" onclick="location.reload()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    <button class="nav-item" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
</nav>

<script>
    const cfg = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
    firebase.initializeApp(cfg); const db = firebase.database();
    let coords = null, sid = localStorage.getItem('sid');

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS ÙÙˆØ±Ø§Ù‹
    navigator.geolocation.getCurrentPosition(p => {
        coords = { lat: p.coords.latitude, lng: p.coords.longitude };
        document.getElementById('gps-msg').innerText = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
        document.getElementById('gps-msg').style.color = "#22c55e";
        document.getElementById('auth-btn').disabled = false;
    }, err => {
        document.getElementById('gps-msg').innerText = "âŒ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹";
    });

    function registerUser() {
        const name = document.getElementById('reg-name').value;
        const phone = document.getElementById('reg-phone').value;
        const code = document.getElementById('reg-code').value;

        if(!name || !phone || !code) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        db.ref('activations/'+code).once('value', s => {
            if(s.exists()){
                localStorage.setItem('auth', '1');
                localStorage.setItem('sid', code);
                localStorage.setItem('u_name', name);
                
                // Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø¯ÙŠØ±
                db.ref('monitoring/'+code).push({
                    user: name, phone: phone, 
                    location: coords, time: new Date().toLocaleString('ar-EG')
                });
                location.reload();
            } else alert("ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­");
        });
    }

    if(localStorage.getItem('auth')){
        document.getElementById('auth-screen').style.display='none';
        document.getElementById('main-h').style.display='block';
        document.getElementById('app-content').style.display='block';
        document.getElementById('main-n').style.display='flex';
        document.getElementById('user-display').innerText = localStorage.getItem('u_name');
        
        db.ref('stores/'+sid).on('value', s => {
            const d = s.val()||{}; const sls = d.sales||[];
            const cash = sls.filter(x=>!x.isD).reduce((a,b)=>a+b.total,0);
            const prof = sls.filter(x=>!x.isD).reduce((a,b)=>a+b.p,0);
            const debt = sls.filter(x=>x.isD).reduce((a,b)=>a+b.total,0);
            document.getElementById('net-p').innerText = prof.toFixed(0);
            document.getElementById('v-s').innerText = cash;
            document.getElementById('v-d').innerText = debt;
        });
    }

    function logout() { localStorage.clear(); location.reload(); }
    function tab(id,b){ /* ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ†Ù‚Ù„ */ }
</script>
</body>
</html>
