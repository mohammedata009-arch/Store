<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-TAHA ERP | Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --main-color: #059669; --bg-soft: #f8fafc; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-soft); margin: 0; overflow: hidden; touch-action: none; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { background: linear-gradient(135deg, #059669 0%, #064e3b 100%); z-index: 9999; position: fixed; inset: 0; }
        
        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡ÙŠÙƒÙ„ÙŠØ© */
        .app-header { background: white; border-bottom: 1px solid #e2e8f0; height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; position: relative; z-index: 1001; }
        
        .viewport { width: 100vw; height: calc(100vh - 130px); position: relative; overflow: hidden; }

        .pages-row {
            display: flex;
            height: 100%;
            width: 300%; 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            will-change: transform;
        }

        .page-item {
            width: 100vw;
            flex: 0 0 100vw;
            padding: 15px;
            overflow-y: auto;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        .card-custom { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        .nav-bottom { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; height: 70px; z-index: 1000; }
        .nav-link-custom { flex: 1; text-align: center; display:flex; flex-direction:column; align-items:center; justify-content:center; color: #94a3b8; font-size: 11px; font-weight: bold; cursor: pointer; }
        .nav-link-custom.active { color: var(--main-color); border-top: 3px solid var(--main-color); }

        .alert-low { background: #fff1f2; border-right: 5px solid #e11d48; color: #9f1239; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }

        @media print {
            .no-print, .nav-bottom, .app-header { display: none !important; }
            body { overflow: visible !important; }
            .viewport { height: auto !important; overflow: visible !important; }
            .pages-row { transform: none !important; display: block !important; width: 100% !important; }
            .page-item { display: none; }
            .page-item:first-child { display: block; }
        }
    </style>
</head>
<body>

<div id="auth-screen" class="d-flex align-items-center justify-content-center text-white">
    <div class="text-center p-4 w-100" style="max-width: 400px;">
        <h1 class="fw-900 mb-3">M-TAHA ERP</h1>
        <div class="bg-white p-4 rounded-4 shadow-lg">
            <input type="text" id="auth-code" class="form-control form-control-lg mb-3 text-center" placeholder="ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„">
            <button class="btn btn-success btn-lg w-100 fw-bold" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
            <p id="login-err" class="text-danger mt-2 small d-none">âš ï¸ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!</p>
        </div>
    </div>
</div>

<div id="main-app" style="display: none;">
    <header class="app-header no-print">
        <span class="fw-bold text-success" id="store-title">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </header>

    <div class="viewport" id="touch-area">
        <div class="pages-row" id="main-slider">
            
            <div class="page-item" id="p-reports">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="card-custom text-center border-bottom border-success border-4">
                            <small class="text-muted">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙŠÙˆÙ…</small>
                            <h4 id="stat-profit" class="fw-bold text-success m-0">0</h4>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card-custom text-center border-bottom border-primary border-4">
                            <small class="text-muted">Ø§Ù„Ù…Ø®Ø²Ù†</small>
                            <h4 id="stat-stock-val" class="fw-bold text-primary m-0">0</h4>
                        </div>
                    </div>
                </div>
                <div class="card-custom">
                    <h6 class="fw-bold mb-2">ğŸš¨ Ù†ÙˆØ§Ù‚Øµ</h6>
                    <div id="low-stock-container"></div>
                </div>
                <div class="card-custom">
                    <h6 class="fw-bold mb-2">ğŸ“Š Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h6>
                    <table class="table table-sm small"><tbody id="sales-table-body"></tbody></table>
                    <div class="text-start fw-bold border-top pt-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="stat-total-sales">0</span></div>
                </div>
                <button class="btn btn-dark w-100 py-3 no-print" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            </div>

            <div class="page-item" id="p-pos">
                <div class="card-custom border-top border-success border-4">
                    <h5 class="fw-bold mb-3">ğŸ›’ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h5>
                    <input type="text" id="pos-search" class="form-control mb-2" placeholder="Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="filterPOS()">
                    <select id="pos-select" class="form-select mb-3" size="5" onchange="autoPrice()"></select>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="number" id="pos-qty" class="form-control" value="1"></div>
                        <div class="col-6"><input type="number" id="pos-price" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±"></div>
                    </div>
                    <button class="btn btn-success w-100 py-3 fw-bold" onclick="submitSale()">ØªØ£ÙƒÙŠØ¯ âœ…</button>
                </div>
            </div>

            <div class="page-item" id="p-stock">
                <div class="card-custom border-top border-primary border-4">
                    <h5 id="stock-title" class="fw-bold mb-3">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h5>
                    <input id="st-name" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                    <div class="row g-2 mb-3">
                        <div class="col-4"><input id="st-qty" type="number" class="form-control" placeholder="ÙƒÙ…ÙŠØ©"></div>
                        <div class="col-4"><input id="st-buy" type="number" class="form-control" placeholder="Ø´Ø±Ø§Ø¡"></div>
                        <div class="col-4"><input id="st-sell" type="number" class="form-control" placeholder="Ø¨ÙŠØ¹"></div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold" onclick="saveToStock()">Ø­ÙØ¸</button>
                </div>
                <div id="stock-list-container"></div>
            </div>

        </div>
    </div>

    <nav class="nav-bottom no-print">
        <div class="nav-link-custom active" id="btn0" onclick="jump(0)">ğŸ“Š<br>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
        <div class="nav-link-custom" id="btn1" onclick="jump(1)">ğŸ›’<br>Ø§Ù„Ø¨ÙŠØ¹</div>
        <div class="nav-link-custom" id="btn2" onclick="jump(2)">ğŸ“¦<br>Ø§Ù„Ù…Ø®Ø²Ù†</div>
    </nav>
</div>

<script>
// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
const firebaseConfig = {
    apiKey: "AIzaSyAYJwvrBLc_svZ2IcWBzrBbK_ZpUqX0G8M",
    databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com",
    projectId: "store-project-b023e",
    appId: "1:561530737705:web:beefb32c081f9bf8b53838"
};
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let sid = localStorage.getItem('m_taha_sid'), data = { p: [], s: [] }, editIdx = -1;
let currentIdx = 0;
const totalPages = 3;

// --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† ---
const slider = document.getElementById('main-slider');
const area = document.getElementById('touch-area');
let startX = 0;

area.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, {passive: true});
area.addEventListener('touchend', (e) => {
    let diff = startX - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 60) {
        if (diff > 0) currentIdx = (currentIdx + 1) % totalPages;
        else currentIdx = (currentIdx - 1 + totalPages) % totalPages;
        jump(currentIdx);
    }
});

function jump(idx) {
    currentIdx = idx;
    slider.style.transform = `translateX(${currentIdx * 100}vw)`;
    document.querySelectorAll('.nav-link-custom').forEach((btn, i) => {
        btn.classList.toggle('active', i === currentIdx);
    });
}

// --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… ---
function login() {
    const code = document.getElementById('auth-code').value.trim();
    rdb.ref('active_stores/'+code).once('value', s => {
        if(s.exists()){ localStorage.setItem('m_taha_sid', code); location.reload(); }
        else document.getElementById('login-err').classList.remove('d-none');
    });
}

if(sid) rdb.ref('active_stores/'+sid).once('value', s => { 
    if(s.exists()){
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        document.getElementById('store-title').innerText = s.val().name;
        rdb.ref('stores_data/'+sid).on('value', ss => { data = ss.val() || { p: [], s: [] }; renderData(); });
    } else logout();
});

function logout() { localStorage.clear(); location.reload(); }

function filterPOS() {
    const q = document.getElementById('pos-search').value.toLowerCase();
    const sel = document.getElementById('pos-select'); sel.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q)) sel.innerHTML += `<option value="${i}">${p.name} (${p.qty})</option>`;
    });
}

function autoPrice() {
    const i = document.getElementById('pos-select').value;
    if(i !== "") document.getElementById('pos-price').value = data.p[i].sell;
}

function submitSale() {
    const i = document.getElementById('pos-select').value, q = +document.getElementById('pos-qty').value, pr = +document.getElementById('pos-price').value;
    if(i === "" || q <= 0) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    const today = new Date().toLocaleDateString('ar-EG');
    if(!data.s) data.s = [];
    data.s.push({ n: data.p[i].name, q: q, t: q*pr, c: q*data.p[i].buy, d: today });
    data.p[i].qty -= q;
    rdb.ref('stores_data/'+sid).set(data).then(() => alert("ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…"));
}

function saveToStock() {
    const n = document.getElementById('st-name').value, q = +document.getElementById('st-qty').value, b = +document.getElementById('st-buy').value, s = +document.getElementById('st-sell').value;
    if(!n) return;
    if(!data.p) data.p = [];
    if(editIdx > -1) { data.p[editIdx] = {name:n, qty:q, buy:b, sell:s}; editIdx = -1; }
    else data.p.push({name:n, qty:q, buy:b, sell:s});
    rdb.ref('stores_data/'+sid).set(data).then(() => { alert("ØªÙ… Ø§Ù„Ø­ÙØ¸"); location.reload(); });
}

function renderData() {
    const today = new Date().toLocaleDateString('ar-EG');
    let pft = 0, ttl = 0, stVal = 0;
    const sBody = document.getElementById('sales-table-body'); sBody.innerHTML = "";
    const lowCont = document.getElementById('low-stock-container'); lowCont.innerHTML = "";
    const stCont = document.getElementById('stock-list-container'); stCont.innerHTML = "";

    (data.s || []).forEach(x => {
        if(x.d === today) { pft += (x.t - x.c); ttl += x.t; sBody.innerHTML += `<tr><td>${x.n}</td><td>${x.q}</td><td>${x.t}</td></tr>`; }
    });

    (data.p || []).forEach((p, i) => {
        stVal += (p.buy * p.qty);
        stCont.innerHTML += `<div class="card-custom d-flex justify-content-between"><span>${p.name} (${p.qty})</span> <button class="btn btn-sm btn-light" onclick="editStock(${i})">âœï¸</button></div>`;
        if(p.qty <= 3) lowCont.innerHTML += `<div class="alert-low">âš ï¸ ${p.name} (Ø¨Ù‚ÙŠ ${p.qty})</div>`;
    });

    document.getElementById('stat-profit').innerText = pft.toLocaleString();
    document.getElementById('stat-total-sales').innerText = ttl.toLocaleString() + " Ø¬";
    document.getElementById('stat-stock-val').innerText = stVal.toLocaleString();
    filterPOS();
}

function editStock(i) {
    editIdx = i;
    const p = data.p[i];
    document.getElementById('st-name').value = p.name;
    document.getElementById('st-qty').value = p.qty;
    document.getElementById('st-buy').value = p.buy;
    document.getElementById('st-sell').value = p.sell;
    jump(2);
}
</script>
</body>
</html>
