<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-TAHA Pro v4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p-green: #059669; --s-bg: #f1f5f9; }
        body { font-family: 'Cairo', sans-serif; background: var(--s-bg); color: #1e293b; margin: 0; }
        #auth-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center; }
        #main-app { display: none; padding-bottom: 80px; }
        .app-card { border: none; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1rem; padding: 15px; background: white; }
        .nav-fixed { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #e2e8f0; z-index: 1000; padding: 12px 0; }
        .nav-item { flex: 1; text-align: center; border: none; background: none; color: #64748b; font-weight: 700; font-size: 13px; }
        .nav-item.active { color: var(--p-green); }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .ticker { background: #fbbf24; color: #000; padding: 8px; font-weight: 900; position: sticky; top: 0; z-index: 1100; display: none; text-align: center; }
    </style>
</head>
<body>

<div id="announcement" class="ticker"></div>

<div id="auth-screen">
    <div class="p-4 w-100 text-center" style="max-width: 400px;">
        <h1 class="fw-black text-success mb-2">M-TAHA</h1>
        <p class="text-muted small mb-4">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø­Ø±ÙˆÙ ÙˆØ£Ø±Ù‚Ø§Ù…)</p>
        <div class="card app-card shadow-lg">
            <input type="text" id="auth-input" class="form-control form-control-lg mb-3 text-center border-2" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" style="-webkit-text-security: disc; font-weight: bold;">
            <button id="login-btn" class="btn btn-success btn-lg w-100 fw-bold shadow" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
            <p id="err" class="text-danger mt-3 small" style="display:none">âš ï¸ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ù…ØªØ¬Ø± ØºÙŠØ± Ù…ÙØ¹Ù„</p>
        </div>
    </div>
</div>

<div id="main-app">
    <header class="bg-white p-3 shadow-sm sticky-top d-flex justify-content-between align-items-center">
        <span class="fw-bold text-success" id="ui-store-name">...</span>
        <button class="btn btn-sm btn-outline-danger fw-bold" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </header>

    <div class="container-fluid">
        <div id="p-dashboard" class="page active">
            <div class="row g-3">
                <div class="col-6"><div class="card app-card"> <small>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</small> <h4 id="res-profit">0</h4> </div></div>
                <div class="col-6"><div class="card app-card"> <small>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</small> <h4 id="res-stock">0</h4> </div></div>
            </div>
            <button class="btn btn-dark w-100 py-3 mt-3 fw-bold" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>

        <div id="p-sales" class="page">
            <div class="card app-card">
                <h6 class="fw-bold mb-3 border-bottom pb-2">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h6>
                <input type="text" id="p-search" class="form-control mb-2" placeholder="Ø¨Ø­Ø«..." onkeyup="searchPr()">
                <select id="p-list" class="form-select mb-3" size="5" onchange="updatePrice()"></select>
                <div class="row g-2 mb-3">
                    <div class="col-6"><input type="number" id="s-qty" class="form-control" value="1"></div>
                    <div class="col-6"><input type="number" id="s-price" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±"></div>
                </div>
                <button class="btn btn-success w-100 py-3 fw-bold" onclick="saveSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
            </div>
        </div>

        <div id="p-stock" class="page">
            <div class="card app-card">
                <h6 class="fw-bold mb-3 border-bottom pb-2 text-primary">ğŸ“¦ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</h6>
                <input id="in-name" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <div class="row g-2 mb-3">
                    <div class="col-6"><input id="in-buy" type="number" class="form-control" placeholder="Ø´Ø±Ø§Ø¡"></div>
                    <div class="col-6"><input id="in-sell" type="number" class="form-control" placeholder="Ø¨ÙŠØ¹"></div>
                </div>
                <button class="btn btn-primary w-100 fw-bold" onclick="addPr()">Ø­ÙØ¸ Ø¨Ø§Ù„Ù…Ø®Ø²Ù†</button>
            </div>
            <div id="stock-list"></div>
        </div>
    </div>

    <nav class="nav-fixed shadow-lg">
        <button class="nav-item active" onclick="tab('dashboard', this)">ğŸ“Š Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
        <button class="nav-item" onclick="tab('sales', this)">ğŸ§¾ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
        <button class="nav-item" onclick="tab('stock', this)">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</button>
    </nav>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYJwvrBLc_svZ2IcWBzrBbK_ZpUqX0G8M",
  authDomain: "store-project-b023e.firebaseapp.com",
  databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com",
  projectId: "store-project-b023e",
  storageBucket: "store-project-b023e.appspot.com",
  messagingSenderId: "561530737705",
  appId: "1:561530737705:web:beefb32c081f9bf8b53838"
};

firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let sid = localStorage.getItem('m_taha_session');
let data = { p: [], s: [] };

function handleAuth() {
    const code = document.getElementById('auth-input').value.trim();
    if(!code) return;
    document.getElementById('login-btn').innerText = "...";
    rdb.ref('active_stores/'+code).once('value', s => {
        if(s.exists()){ localStorage.setItem('m_taha_session', code); sid = code; showApp(s.val().name); }
        else { document.getElementById('err').style.display='block'; document.getElementById('login-btn').innerText="Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†"; }
    });
}

function showApp(name) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    document.getElementById('ui-store-name').innerText = name;
    rdb.ref('stores_data/'+sid).on('value', ss => {
        data = ss.val() || { p: [], s: [] };
        render();
    });
    rdb.ref('admin_announcement').on('value', s => {
        const t = document.getElementById('announcement');
        if(s.val()){ t.innerText = "ğŸ“¢ " + s.val(); t.style.display = 'block'; }
        else t.style.display = 'none';
    });
}

if(sid) rdb.ref('active_stores/'+sid).once('value', s => { if(s.exists()) showApp(s.val().name); else logout(); });

function tab(t, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('p-'+t).classList.add('active');
    btn.classList.add('active');
}

function updatePrice() {
    const i = document.getElementById('p-list').value;
    if(i !== "") document.getElementById('s-price').value = data.p[i].sell;
}

function searchPr() {
    const q = document.getElementById('p-search').value.toLowerCase();
    const l = document.getElementById('p-list'); l.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q)) l.innerHTML += `<option value="${i}">${p.name}</option>`;
    });
}

function saveSale() {
    const i = document.getElementById('p-list').value;
    const q = +document.getElementById('s-qty').value;
    const pr = +document.getElementById('s-price').value;
    if(i === "" || q <= 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if(!data.s) data.s = [];
    data.s.push({ n: data.p[i].name, q: q, t: q*pr, c: q*data.p[i].buy });
    rdb.ref('stores_data/'+sid).set(data);
    alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ âœ…");
}

function addPr() {
    const n = document.getElementById('in-name').value, b = +document.getElementById('in-buy').value, s = +document.getElementById('in-sell').value;
    if(!n || b<=0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if(!data.p) data.p = [];
    data.p.push({name:n, buy:b, sell:s});
    rdb.ref('stores_data/'+sid).set(data);
    document.getElementById('in-name').value = "";
}

function render() {
    let profit = 0, stock = 0;
    (data.s || []).forEach(x => profit += (x.t - x.c));
    (data.p || []).forEach(x => stock += x.buy);
    document.getElementById('res-profit').innerText = profit.toLocaleString() + " Ø¬";
    document.getElementById('res-stock').innerText = stock.toLocaleString() + " Ø¬";
    const sl = document.getElementById('stock-list'); sl.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        sl.innerHTML += `<div class="card app-card d-flex flex-row justify-content-between">
            <b>${p.name} <br><small>${p.sell} Ø¬</small></b>
            <button class="btn btn-sm btn-outline-danger" onclick="delPr(${i})">Ø­Ø°Ù</button>
        </div>`;
    });
    searchPr();
}

function delPr(i) { if(confirm("Ø­Ø°ÙØŸ")) { data.p.splice(i,1); rdb.ref('stores_data/'+sid).set(data); } }
function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
