<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-TAHA ERP Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p-color: #10b981; --s-color: #1e293b; --danger: #ef4444; }
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; color: var(--s-color); overflow-x: hidden; }
        .app-card { border: none; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); transition: 0.3s; }
        .nav-fixed { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #e2e8f0; z-index: 1000; padding: 10px 0; }
        .nav-item { flex: 1; text-align: center; border: none; background: none; color: #94a3b8; font-weight: 700; font-size: 13px; }
        .nav-item.active { color: var(--p-color); }
        .page { display: none; padding: 20px; animation: slideUp 0.4s ease; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .ticker { background: #fbbf24; color: #000; padding: 10px; font-weight: 900; position: sticky; top: 0; z-index: 1100; display: none; font-size: 14px; text-align: center; }
    </style>
</head>
<body>

<div id="announcement" class="ticker shadow-sm"></div>

<div id="auth-screen" class="vh-100 vw-100 bg-white d-flex align-items-center justify-content-center position-fixed" style="z-index: 2000;">
    <div class="p-4 w-100" style="max-width: 400px;">
        <div class="text-center mb-4">
            <h1 class="fw-black text-success" style="font-size: 2.5rem;">M-TAHA</h1>
            <p class="text-muted">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ v3.0</p>
        </div>
        <div class="card app-card p-4">
            <label class="form-label fw-bold">ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</label>
            <input type="password" id="auth-input" class="form-control form-control-lg mb-3 border-2" placeholder="â€¢â€¢â€¢â€¢">
            <button class="btn btn-success btn-lg w-100 fw-bold shadow" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
            <div class="mt-4 text-center small border-top pt-3">
                Ù„Ù„ØªÙØ¹ÙŠÙ„ ÙˆØ·Ù„Ø¨ Ù†Ø³Ø®Ø©: <br> <b class="text-dark">0901946410</b>
            </div>
        </div>
    </div>
</div>

<div id="app-ui" style="display: none;">
    <header class="bg-white p-3 shadow-sm d-flex justify-content-between align-items-center">
        <b class="text-success h5 m-0" id="ui-store-name">...</b>
        <button class="btn btn-sm btn-outline-danger fw-bold" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </header>

    <div class="container-fluid mb-5 pb-5">
        <div id="p-dashboard" class="page active">
            <div class="row g-3">
                <div class="col-6">
                    <div class="card app-card p-3 bg-white border-start border-success border-4">
                        <small class="text-muted">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</small>
                        <h3 class="fw-bold mb-0" id="res-profit">0</h3>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card app-card p-3 bg-white border-start border-danger border-4">
                        <small class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</small>
                        <h3 class="fw-bold mb-0 text-danger" id="res-debt">0</h3>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card app-card p-4">
                        <h6 class="fw-bold text-muted border-bottom pb-2 mb-3">Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</h6>
                        <div class="d-flex justify-content-between mb-2"><span>Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª (ÙƒØ§Ø´):</span><b id="res-cash">0</b></div>
                        <div class="d-flex justify-content-between mb-2"><span>Ù‚ÙŠÙ…Ø© Ø¨Ø¶Ø§Ø¹Ø© Ø§Ù„Ù…Ø®Ø²Ù†:</span><b id="res-stock">0</b></div>
                        <div class="d-flex justify-content-between"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span><b class="text-danger" id="res-exp">0</b></div>
                    </div>
                </div>
            </div>
            <button class="btn btn-dark w-100 mt-4 py-3 fw-bold" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
            <button class="btn btn-outline-danger w-100 mt-2 btn-sm" onclick="dailyReset()">ØªØµÙÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
        </div>

        <div id="p-sales" class="page">
            <div class="card app-card p-3">
                <h5 class="fw-bold mb-3">ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h5>
                <input type="text" id="p-search" class="form-control mb-2 p-3" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="searchPr()">
                <select id="p-list" class="form-select mb-3" size="5"></select>
                <div class="row g-2 mb-3">
                    <div class="col-6"><label class="small">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" id="s-qty" class="form-control"></div>
                    <div class="col-6"><label class="small">Ø§Ù„Ø³Ø¹Ø±</label><input type="number" id="s-price" class="form-control"></div>
                </div>
                <div class="bg-light p-3 rounded-3 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is-debt">
                        <label class="form-check-label fw-bold">Ø¨ÙŠØ¹ Ø¢Ø¬Ù„ (Ø¯ÙŠÙ†)</label>
                    </div>
                    <input type="text" id="cust-name" class="form-control mt-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„.." style="display:none">
                </div>
                <button class="btn btn-success w-100 py-3 fw-bold" onclick="saveSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
            </div>
        </div>

        <div id="p-stock" class="page">
            <div class="card app-card p-3 mb-3">
                <h5 class="fw-bold mb-3">ğŸ“¦ Ø¨Ø¶Ø§Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <input id="in-name" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <div class="row g-2 mb-3">
                    <div class="col-4"><input id="in-buy" type="number" class="form-control" placeholder="Ø´Ø±Ø§Ø¡"></div>
                    <div class="col-4"><input id="in-sell" type="number" class="form-control" placeholder="Ø¨ÙŠØ¹"></div>
                    <div class="col-4"><input id="in-qty" type="number" class="form-control" placeholder="ÙƒÙ…ÙŠØ©"></div>
                </div>
                <button class="btn btn-primary w-100 fw-bold" onclick="addPr()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù†</button>
            </div>
            <div id="stock-render"></div>
        </div>
    </div>
</div>

<nav class="nav-fixed shadow">
    <button class="nav-item active" onclick="tab('dashboard', this)">ğŸ“Š Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button class="nav-item" onclick="tab('sales', this)">ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    <button class="nav-item" onclick="tab('stock', this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
</nav>

<script>
// Firebase Config
const firebaseConfig = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
rdb.ref().keepSynced(true); // Ø§Ù„Ø¹Ù…Ù„ Offline

let sid = localStorage.getItem('m_taha_session');
let data = { p: [], s: [] };

function handleAuth() {
    const code = document.getElementById('auth-input').value.trim();
    rdb.ref('active_stores/'+code).once('value', s => {
        if(s.exists()){ localStorage.setItem('m_taha_session', code); location.reload(); }
        else alert("ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!");
    });
}

if(sid) {
    rdb.ref('active_stores/'+sid).on('value', s => {
        if(!s.exists()) logout();
        else {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            document.getElementById('ui-store-name').innerText = s.val().name;
            rdb.ref('stores_data/'+sid).on('value', ss => {
                data = ss.val() || { p: [], s: [] };
                render();
            });
        }
    });
    rdb.ref('admin_announcement').on('value', s => {
        const t = document.getElementById('announcement');
        if(s.val()){ t.innerText = "ğŸ“¢ " + s.val(); t.style.display = 'block'; }
        else t.style.display = 'none';
    });
}

function tab(t, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('p-'+t).classList.add('active');
    btn.classList.add('active');
}

document.getElementById('is-debt').onchange = function() {
    document.getElementById('cust-name').style.display = this.checked ? 'block' : 'none';
};

function searchPr() {
    const q = document.getElementById('p-search').value.toLowerCase();
    const list = document.getElementById('p-list'); list.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q))
            list.innerHTML += `<option value="${i}">${p.name} (Ø§Ù„Ù…ØªÙˆÙØ±: ${p.qty})</option>`;
    });
}

function saveSale() {
    const idx = document.getElementById('p-list').value;
    const qty = +document.getElementById('s-qty').value;
    const pr = +document.getElementById('s-price').value;
    const isD = document.getElementById('is-debt').checked;
    if(idx==="" || qty <= 0 || data.p[idx].qty < qty) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„ÙƒÙ…ÙŠØ©!");

    if(!data.s) data.s = [];
    data.s.push({ n: data.p[idx].name, q: qty, t: qty*pr, c: qty*data.p[idx].buy, d: isD });
    data.p[idx].qty -= qty;
    sync();
    alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
}

function addPr() {
    const n = document.getElementById('in-name').value, b = +document.getElementById('in-buy').value, s = +document.getElementById('in-sell').value, q = +document.getElementById('in-qty').value;
    if(!n || b<=0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
    if(!data.p) data.p = [];
    data.p.push({name:n, buy:b, sell:s, qty:q});
    sync();
}

function sync() { rdb.ref('stores_data/'+sid).set(data); }

function render() {
    let profit = 0, debt = 0, cash = 0, stock = 0;
    (data.s || []).forEach(x => {
        if(!x.d) { profit += (x.t - x.c); cash += x.t; }
        else { debt += x.t; }
    });
    (data.p || []).forEach(x => stock += (x.qty * x.buy));

    document.getElementById('res-profit').innerText = profit.toLocaleString() + " Ø¬";
    document.getElementById('res-debt').innerText = debt.toLocaleString() + " Ø¬";
    document.getElementById('res-cash').innerText = cash.toLocaleString() + " Ø¬";
    document.getElementById('res-stock').innerText = stock.toLocaleString() + " Ø¬";

    const inv = document.getElementById('stock-render'); inv.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        inv.innerHTML += `<div class="card app-card p-3 mb-2 d-flex flex-row justify-content-between">
            <b>${p.name} <small class="text-muted">(${p.qty})</small></b>
            <button class="btn btn-sm text-danger fw-bold" onclick="delPr(${i})">Ø­Ø°Ù</button>
        </div>`;
    });
    searchPr();
}

function delPr(i) { if(confirm("Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ")) { data.p.splice(i,1); sync(); } }
function logout() { localStorage.clear(); location.reload(); }
function dailyReset() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ")) { data.s = []; sync(); } }
</script>
</body>
</html>
