<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… M-TAHA Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --warning:#f39c12; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:100px; overflow-x: hidden; }
        
        .page { display: none; }
        .page.active { display: block; }

        header { background: var(--secondary); color: white; padding: 20px 0 55px 0; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: -35px 15px 0 15px; position: relative; z-index: 10; }
        .stat-card { background: white; padding: 15px 5px; border-radius: 15px; text-align: center; box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        .stat-card b { color: var(--primary); font-size: 17px; display: block; }

        .container { padding: 15px; max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 18px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        input, select { width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 12px; margin-bottom: 15px; font-family: 'Cairo'; box-sizing: border-box; font-size: 15px; }

        .main-btn { width: 100%; padding: 15px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 10px; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */
        #toast { 
            visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; 
            border-radius: 10px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 100px; 
            transform: translateX(-50%); font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        #print-area { display: none; }
        @media print { 
            body * { display: none !important; } 
            #print-area { display: block !important; padding: 20px; direction: rtl; font-family: 'Cairo'; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #000; padding: 8px; text-align: center; }
        }

        .bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px 0; box-shadow:0 -5px 20px rgba(0,0,0,0.08); z-index: 1000; }
        .nav-item { border:none; background:none; color:#bdc3c7; font-size: 11px; cursor:pointer; font-family:'Cairo'; }
        .nav-item.active { color:var(--primary); font-weight:900; }
    </style>
</head>
<body>

<div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…</div>

<div id="print-area">
    <h2 id="p-store-name">ØªÙ€Ù‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
    <p id="p-date"></p>
    <hr>
    <table>
        <thead>
            <tr>
                <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            </tr>
        </thead>
        <tbody id="print-list"></tbody>
    </table>
    <div style="margin-top: 20px; font-weight: bold;">
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…: <span id="p-total-sales"></span></p>
        <p>ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­: <span id="p-total-profit"></span></p>
    </div>
</div>

<div id="lock-screen" style="display:flex; position:fixed; inset:0; background:var(--bg); z-index:9999; align-items:center; justify-content:center; text-align:center;">
    <div class="card" style="width: 85%;">
        <h2>Ù†Ø¸Ø§Ù… M-TAHA</h2>
        <input type="text" id="reg-sid" placeholder="ID Ø§Ù„Ù…ØªØ¬Ø±">
        <button class="main-btn" onclick="checkAuth()">Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<div id="app-content" style="display:none;">
    <header>
        <button onclick="logout()" style="position:absolute; left:15px; top:15px; background:none; border:1px solid #fff; color:#fff; border-radius:8px; padding:5px 10px;">Ø®Ø±ÙˆØ¬</button>
        <h3 id="display-store-name">ØªØ­Ù…ÙŠÙ„...</h3>
    </header>
    
    <div class="stat-grid">
        <div class="stat-card"><span>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span><b id="s-total">0</b></div>
        <div class="stat-card"><span>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</span><b id="p-total">0</b></div>
    </div>

    <div class="container">
        <div id="home" class="page active">
            <div class="card">
                <h4>ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h4>
                <p>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: <b id="e-total" style="color:var(--danger)">0</b></p>
                <p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <b id="final-profit" style="color:var(--primary)">0</b></p>
            </div>
            <button class="main-btn" style="background:var(--warning)" onclick="prepareAndPrint()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
            <button class="main-btn" style="background:var(--danger)" onclick="dailyReset()">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
        </div>

        <div id="sell" class="page">
            <div class="card">
                <h3>ğŸ§¾ Ø¨ÙŠØ¹</h3>
                <input type="text" id="search" placeholder="Ø¨Ø­Ø«..." onkeyup="search()">
                <select id="p-select" size="4" onchange="if(this.value!=='') document.getElementById('p-price-edit').value = storeData.p[this.value].sell"></select>
                <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <input type="number" id="p-price-edit" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ âœ…</button>
            </div>
        </div>

        <div id="stock" class="page">
            <div class="card">
                <h3>ğŸ“¦ Ø§Ù„Ù…Ø®Ø²Ù†</h3>
                <input id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <input id="in-buy" type="number" placeholder="Ø´Ø±Ø§Ø¡">
                <input id="in-sell" type="number" placeholder="Ø¨ÙŠØ¹">
                <input id="in-q" type="number" placeholder="ÙƒÙ…ÙŠØ©">
                <button class="main-btn" onclick="saveStock()">Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="full-inventory"></div>
        </div>

        <div id="expenses" class="page">
            <div class="card">
                <h3>ğŸ’¸ Ù…ØµØ±ÙˆÙØ§Øª</h3>
                <input id="exp-name" placeholder="Ø§Ù„Ø¨ÙŠØ§Ù†">
                <input id="exp-amt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                <button class="main-btn" style="background:var(--danger)" onclick="addExp()">Ø®ØµÙ…</button>
            </div>
            <div id="exp-list"></div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="tab('home',this)">ğŸ“Š Ø­Ø³Ø§Ø¨Ø§Øª</button>
        <button class="nav-item" onclick="tab('sell',this)">ğŸ§¾ Ø¨ÙŠØ¹</button>
        <button class="nav-item" onclick="tab('stock',this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
        <button class="nav-item" onclick="tab('expenses',this)">ğŸ’¸ Ù…ØµØ±ÙˆÙ</button>
    </div>
</div>

<script>
const firebaseConfig = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
let sid = localStorage.getItem('m_taha_sid');
let storeData = { p: [], s: [], e: [] };

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
function showToast(msg) {
    let t = document.getElementById("toast");
    t.innerText = msg;
    t.className = "show";
    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
}

function checkAuth() {
    let id = document.getElementById('reg-sid').value.trim();
    rdb.ref('requests/'+id).once('value', s => {
        if(s.exists() && s.val().status === 'active') {
            localStorage.setItem('m_taha_sid', id);
            location.reload();
        } else { alert("ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„"); }
    });
}

function logout() { localStorage.removeItem('m_taha_sid'); location.reload(); }

if(sid) {
    rdb.ref('requests/'+sid).on('value', s => {
        if(s.val()?.status === 'active') {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            document.getElementById('display-store-name').innerText = s.val().name;
            rdb.ref('stores/'+sid).on('value', ss => { storeData = ss.val() || { p: [], s: [], e: [] }; render(); });
        } else { logout(); }
    });
}

function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function search() {
    let q = document.getElementById('search').value.toLowerCase();
    let s = document.getElementById('p-select'); s.innerHTML = "";
    (storeData.p || []).forEach((p, i) => { if(p.name.toLowerCase().includes(q)) s.innerHTML += `<option value="${i}">${p.name} (${p.qty})</option>`; });
}

function doSale() {
    let i = document.getElementById('p-select').value, q = +document.getElementById('p-qty').value, pr = +document.getElementById('p-price-edit').value;
    if(i==="" || q<=0) return;
    if(!storeData.s) storeData.s = [];
    storeData.s.push({ n: storeData.p[i].name, q: q, t: q*pr, c: q*storeData.p[i].buy });
    storeData.p[i].qty -= q;
    sync();
    document.getElementById('p-qty').value = "";
    document.getElementById('p-price-edit').value = "";
    showToast("ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ âœ…");
}

function saveStock() {
    let n = document.getElementById('in-name').value, q = +document.getElementById('in-q').value;
    if(!n || q<=0) return;
    if(!storeData.p) storeData.p = [];
    storeData.p.push({name:n, buy:+document.getElementById('in-buy').value, sell:+document.getElementById('in-sell').value, qty:q});
    sync();
    document.getElementById('in-name').value = ""; document.getElementById('in-q').value = "";
    showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø®Ø²Ù† ğŸ“¦");
}

function addExp() {
    let n = document.getElementById('exp-name').value, a = +document.getElementById('exp-amt').value;
    if(!n || a<=0) return;
    if(!storeData.e) storeData.e = [];
    storeData.e.push({n, a});
    sync();
    document.getElementById('exp-name').value = ""; document.getElementById('exp-amt').value = "";
    showToast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ ğŸ’¸");
}

function sync() { rdb.ref('stores/'+sid).set(storeData); }

// ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©
function prepareAndPrint() {
    let list = document.getElementById('print-list');
    list.innerHTML = "";
    let ts = 0, tc = 0;
    
    (storeData.s || []).forEach(item => {
        list.innerHTML += `<tr><td>${item.n}</td><td>${item.q}</td><td>${item.t}</td></tr>`;
        ts += item.t; tc += item.c;
    });

    document.getElementById('p-store-name').innerText = document.getElementById('display-store-name').innerText;
    document.getElementById('p-date').innerText = "ØªØ§Ø±ÙŠØ®: " + new Date().toLocaleString('ar-EG');
    document.getElementById('p-total-sales').innerText = ts + " Ø¬";
    document.getElementById('p-total-profit').innerText = (ts - tc) + " Ø¬";
    
    window.print();
}

function dailyReset() { if(confirm("ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…ØŸ")) { storeData.s = []; storeData.e = []; sync(); } }

function render() {
    let ts=0, tc=0, te=0;
    (storeData.s || []).forEach(x => { ts += x.t; tc += x.c; });
    (storeData.e || []).forEach(x => { te += x.a; });
    document.getElementById('s-total').innerText = ts;
    document.getElementById('p-total').innerText = (ts - tc);
    document.getElementById('e-total').innerText = te;
    document.getElementById('final-profit').innerText = ((ts - tc) - te);
    
    let invDiv = document.getElementById('full-inventory'); invDiv.innerHTML = "<h4>Ø§Ù„Ø¬Ø±Ø¯:</h4>";
    (storeData.p || []).forEach((p, i) => {
        invDiv.innerHTML += `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee;"><span>${p.name} (${p.qty})</span> <button onclick="storeData.p.splice(${i},1);sync()" style="color:red;border:none;background:none;">Ø­Ø°Ù</button></div>`;
    });
}
</script>
</body>
</html>
