<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… M-TAHA Smart</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary:#27ae60; --secondary:#2c3e50; --bg:#f4f7f6; --danger:#e74c3c; --warning:#f39c12; --info:#3498db; --purple:#8e44ad; }
        body { font-family:'Cairo',sans-serif; background:var(--bg); margin:0; padding-bottom:100px; color: #333; -webkit-tap-highlight-color: transparent; }
        
        .ticker { background: var(--secondary); color: white; padding: 10px 0; overflow: hidden; white-space: nowrap; font-size: 13px; font-weight: bold; }
        .ticker span { display: inline-block; animation: move 20s linear infinite; padding-right: 100%; }
        @keyframes move { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }

        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        header { background: var(--secondary); color: white; padding: 20px 0 45px 0; text-align: center; border-radius: 0 0 30px 30px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: -30px 15px 0 15px; }
        .stat-card { background: white; padding: 12px; border-radius: 18px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-bottom: 4px solid var(--primary); }
        .stat-card b { font-size: 18px; color: var(--primary); display: block; }

        .card { background: white; border-radius: 20px; padding: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; margin-bottom: 10px; font-family: 'Cairo'; box-sizing: border-box; font-size: 15px; outline: none; }
        input:focus { border-color: var(--primary); }
        .main-btn { width: 100%; padding: 14px; border: none; border-radius: 12px; background: var(--primary); color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .main-btn:active { transform: scale(0.95); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        th { background: #f8f9fa; padding: 12px; font-size: 13px; border-bottom: 2px solid #eee; }
        td { padding: 12px; text-align: center; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
        .row-danger { background: #fff5f5; color: #d32f2f; font-weight: 900; }
        .row-warning { background: #fffdf0; color: #af7a07; }
        .row-success { background: #f0fff4; color: #2d6a4f; }

        .bottom-nav { position:fixed; bottom:0; width:100%; background:white; display:flex; justify-content:space-around; padding:12px 0; box-shadow:0 -5px 20px rgba(0,0,0,0.1); z-index:1000; }
        .nav-item { border:none; background:none; color:#bdc3c7; font-size: 11px; cursor:pointer; font-family:'Cairo'; transition: 0.3s; }
        .nav-item.active { color:var(--primary); font-weight:900; transform: translateY(-3px); }

        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 2000; left: 50%; bottom: 100px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadeinout 2.5s; }
        @keyframes fadeinout { 0%,100% {opacity:0} 10%,90% {opacity:1} }
    </style>
</head>
<body>

<div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…</div>

<div class="ticker">
    <span>Ù†Ø¸Ø§Ù… M-TAHA Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ .. Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù†ÙˆØ§Ù‚Øµ .. Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø­Ù…Ø± ÙŠØ¹Ù†ÙŠ Ù†ÙØ§Ø° Ø§Ù„ÙƒÙ…ÙŠØ©.</span>
</div>

<header><h3>M-TAHA SMART</h3></header>

<div class="stat-grid">
    <div class="stat-card"><span>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span><b id="s-total">0</b></div>
    <div class="stat-card" style="border-color: var(--purple);"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ†</span><b id="d-total" style="color:var(--purple)">0</b></div>
</div>

<div id="app-content">
    <div id="stats" class="page">
        <div class="card">
            <h4>ğŸ“ˆ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ Ø§Ù„Ø°ÙƒÙŠ</h4>
            <table id="stock-analysis-table">
                <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                <tbody id="analysis-body"></tbody>
            </table>
        </div>
        <div class="card">
            <h4>ğŸ”¥ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…</h4>
            <div id="top-selling-list"></div>
        </div>
    </div>

    <div id="home" class="page active">
        <div class="card">
            <h4>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
            <button class="main-btn" onclick="window.print()" style="background:var(--info)">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (PDF)</button>
            <button class="main-btn" style="background:var(--danger); margin-top:10px;" onclick="dailyReset()">ğŸ§¹ ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
        </div>
    </div>

    <div id="sell" class="page">
        <div class="card">
            <h3>ğŸ§¾ ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h3>
            <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." onkeyup="render()">
            <select id="p-select" size="5" style="height: 150px;"></select>
            <input type="number" id="p-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <button class="main-btn" onclick="doSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¹ âœ…</button>
        </div>
    </div>

    <div id="stock" class="page">
        <div class="card">
            <h3>ğŸ“¦ ØªÙˆØ±ÙŠØ¯ Ø¨Ø¶Ø§Ø¹Ø©</h3>
            <input id="in-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
            <div style="display: flex; gap: 5px;">
                <input id="in-buy" type="number" placeholder="Ø´Ø±Ø§Ø¡">
                <input id="in-sell" type="number" placeholder="Ø¨ÙŠØ¹">
            </div>
            <input id="in-q" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
            <label style="font-size: 11px;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input id="in-exp" type="date">
            <button class="main-btn" onclick="saveStock()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</button>
        </div>
        <div id="full-inventory"></div>
    </div>

    <div id="debts" class="page">
        <div class="card">
            <h3>ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙŠÙˆÙ†</h3>
            <input id="d-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ">
            <input id="d-amt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <textarea id="d-notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª.."></textarea>
            <button class="main-btn" style="background:var(--purple)" onclick="addDebt()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ†</button>
        </div>
        <div id="debts-list"></div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-item" onclick="tab('stats',this)">ğŸ“ˆ Ø¥Ø­ØµØ§Ø¡</button>
    <button class="nav-item active" onclick="tab('home',this)">ğŸ“Š Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button class="nav-item" onclick="tab('sell',this)">ğŸ§¾ Ø¨ÙŠØ¹</button>
    <button class="nav-item" onclick="tab('stock',this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
    <button class="nav-item" onclick="tab('debts',this)">ğŸ“ Ø¯ÙŠÙˆÙ†</button>
</div>

<script>
const firebaseConfig = { databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();
let sid = localStorage.getItem('m_taha_sid') || "demo"; 
let storeData = { p: [], s: [], d: [] };

rdb.ref('stores/'+sid).on('value', ss => { 
    storeData = ss.val() || { p: [], s: [], d: [] }; 
    render(); 
});

function toast(m) { let x=document.getElementById("toast"); x.innerText=m; x.className="show"; setTimeout(()=>{x.className=""},2500); }

function tab(id, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    btn.classList.add('active');
}

function sync() { rdb.ref('stores/'+sid).set(storeData); }

function saveStock() {
    let n = document.getElementById('in-name').value, q = +document.getElementById('in-q').value;
    if(!n || q <= 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if(!storeData.p) storeData.p = [];
    storeData.p.push({name:n, buy:+document.getElementById('in-buy').value||0, sell:+document.getElementById('in-sell').value||0, qty:q, exp:document.getElementById('in-exp').value});
    sync();
    toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù ğŸ“¦");
    document.getElementById('in-name').value=""; document.getElementById('in-q').value="";
}

function doSale() {
    let i = document.getElementById('p-select').value, q = +document.getElementById('p-qty').value;
    if(i==="" || q<=0) return alert("Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù ÙˆØ§Ù„ÙƒÙ…ÙŠØ©");
    if(storeData.p[i].qty < q) return alert("Ø§Ù„ÙƒÙ…ÙŠØ© Ø¨Ø§Ù„Ù…Ø®Ø²Ù† ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");
    if(!storeData.s) storeData.s = [];
    storeData.s.push({ n: storeData.p[i].name, q, t: q*storeData.p[i].sell, c: q*storeData.p[i].buy });
    storeData.p[i].qty -= q;
    sync();
    toast("ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹ ğŸ§¾");
    document.getElementById('p-qty').value = "";
}

function addDebt() {
    let n = document.getElementById('d-name').value, a = +document.getElementById('d-amt').value;
    if(!n || a <= 0) return;
    if(!storeData.d) storeData.d = [];
    storeData.d.push({n, a, not:document.getElementById('d-notes').value});
    sync();
    toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ† ğŸ“");
    document.getElementById('d-name').value=""; document.getElementById('d-amt').value="";
}

function render() {
    let ts=0, td=0;
    (storeData.s || []).forEach(x => ts += x.t);
    (storeData.d || []).forEach(x => td += x.a);
    document.getElementById('s-total').innerText = ts.toLocaleString() + " Ø¬";
    document.getElementById('d-total').innerText = td.toLocaleString() + " Ø¬";

    // Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù†ÙˆØ§Ù‚Øµ
    let analysisBody = document.getElementById('analysis-body'); analysisBody.innerHTML = "";
    (storeData.p || []).forEach(p => {
        let st = "Ù…ØªÙˆÙØ±", cls = "row-success";
        if(p.qty <= 0) { st = "Ù…Ù†ØªÙ‡ÙŠ"; cls = "row-danger"; }
        else if(p.qty <= 5) { st = "Ù†Ù‚Øµ"; cls = "row-warning"; }
        analysisBody.innerHTML += `<tr class="${cls}"><td>${p.name}</td><td>${p.qty}</td><td>${st}</td></tr>`;
    });

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
    let s = document.getElementById('p-select'); s.innerHTML = "";
    let q = document.getElementById('search').value.toLowerCase();
    (storeData.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q)) s.innerHTML += `<option value="${i}">${p.name} (Ø§Ù„Ù…ØªÙˆÙØ±: ${p.qty})</option>`;
    });

    // Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†
    let inv = document.getElementById('full-inventory'); inv.innerHTML = "<h4>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>";
    (storeData.p || []).forEach((p, i) => {
        inv.innerHTML += `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center;">
            <span><b>${p.name}</b> (${p.qty} Ù‚Ø·Ø¹Ø©)</span>
            <button onclick="if(confirm('Ø­Ø°ÙØŸ')){storeData.p.splice(${i},1);sync();}" style="color:red; background:none; border:none;">Ø­Ø°Ù</button>
        </div>`;
    });

    // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†
    let dList = document.getElementById('debts-list'); dList.innerHTML = "<h4>Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>";
    (storeData.d || []).forEach((d, i) => {
        dList.innerHTML += `<div class="card" style="border-right:6px solid var(--purple)">
            <b>${d.n}</b>: ${d.a} Ø¬ <br> <small>${d.not || ''}</small>
            <button onclick="if(confirm('Ø³Ø¯Ø§Ø¯ØŸ')){storeData.d.splice(${i},1);sync();}" style="float:left; color:green; background:none; border:none; font-weight:bold;">ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ âœ“</button>
        </div>`;
    });
}

function dailyReset() { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ØŸ")) { storeData.s = []; sync(); toast("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©"); } }
</script>
</body>
</html>
