<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-TAHA ERP Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p-color: #10b981; --s-color: #1e293b; }
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; color: var(--s-color); }
        .app-card { border: none; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .nav-fixed { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #e2e8f0; z-index: 1000; padding: 10px 0; }
        .nav-item { flex: 1; text-align: center; border: none; background: none; color: #94a3b8; font-weight: 700; font-size: 13px; }
        .nav-item.active { color: var(--p-color); }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .ticker { background: #fbbf24; color: #000; padding: 10px; font-weight: 900; position: sticky; top: 0; z-index: 1100; display: none; text-align: center; }
    </style>
</head>
<body>

<div id="announcement" class="ticker"></div>

<div id="auth-screen" class="vh-100 vw-100 bg-white d-flex align-items-center justify-content-center position-fixed" style="z-index: 2000;">
    <div class="p-4 w-100" style="max-width: 400px;">
        <div class="text-center mb-4">
            <h1 class="fw-black text-success">M-TAHA</h1>
            <p class="text-muted">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø°ÙƒÙŠ</p>
        </div>
        <div class="card app-card p-4 text-center">
            <label class="form-label fw-bold">ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
            <input type="text" id="auth-input" inputmode="numeric" class="form-control form-control-lg mb-3 border-2 text-center" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø®Ø§Øµ" style="-webkit-text-security: disc;">
            <button class="btn btn-success btn-lg w-100 fw-bold" onclick="handleAuth()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
        </div>
    </div>
</div>

<div id="app-ui" style="display: none;">
    <header class="bg-white p-3 shadow-sm d-flex justify-content-between">
        <b class="text-success" id="ui-store-name">...</b>
        <button class="btn btn-sm btn-outline-danger" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </header>

    <div class="container-fluid mb-5 pb-5">
        <div id="p-dashboard" class="page active">
            <div class="row g-3">
                <div class="col-6"><div class="card app-card p-3"><span>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</span><h3 id="res-profit">0</h3></div></div>
                <div class="col-6"><div class="card app-card p-3"><span class="text-danger">Ø§Ù„Ø¯ÙŠÙˆÙ†</span><h3 id="res-debt">0</h3></div></div>
            </div>
            <button class="btn btn-dark w-100 mt-4 py-3" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>

        <div id="p-sales" class="page">
            <div class="card app-card p-3">
                <h5>ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§Øª</h5>
                <input type="text" id="p-search" class="form-control mb-2" placeholder="Ø¨Ø­Ø«..." onkeyup="searchPr()">
                <select id="p-list" class="form-select mb-3" size="4"></select>
                <input type="number" id="s-qty" class="form-control mb-2" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <input type="number" id="s-price" class="form-control mb-3" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <button class="btn btn-success w-100 py-3" onclick="saveSale()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ…</button>
            </div>
        </div>

        <div id="p-stock" class="page">
            <div class="card app-card p-3 mb-3">
                <h5>ğŸ“¦ Ø¥Ø¶Ø§ÙØ© Ø¨Ø¶Ø§Ø¹Ø©</h5>
                <input id="in-name" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                <div class="row g-2 mb-3">
                    <div class="col-6"><input id="in-buy" type="number" class="form-control" placeholder="Ø´Ø±Ø§Ø¡"></div>
                    <div class="col-6"><input id="in-sell" type="number" class="form-control" placeholder="Ø¨ÙŠØ¹"></div>
                </div>
                <button class="btn btn-primary w-100" onclick="addPr()">Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù†</button>
            </div>
            <div id="stock-render"></div>
        </div>
    </div>
</div>

<nav class="nav-fixed">
    <button class="nav-item active" onclick="tab('dashboard', this)">ğŸ“Š Ø­Ø³Ø§Ø¨Ø§Øª</button>
    <button class="nav-item" onclick="tab('sales', this)">ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§Øª</button>
    <button class="nav-item" onclick="tab('stock', this)">ğŸ“¦ Ù…Ø®Ø²Ù†</button>
</nav>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† ØµÙˆØ±ØªÙƒ Ù…Ø¨Ø§Ø´Ø±Ø©
const firebaseConfig = {
  apiKey: "AIzaSyAYJwvrBLc_svZ2IcWBzrBbK_ZpUqX0G8M",
  authDomain: "store-project-b023e.firebaseapp.com",
  databaseURL: "https://store-project-b023e-default-rtdb.firebaseio.com",
  projectId: "store-project-b023e",
  storageBucket: "store-project-b023e.appspot.com",
  messagingSenderId: "561530737705",
  appId: "1:561530737705:web:beefb32c081f9bf8b53838"
};

firebase.initializeApp(firebaseConfig);
const rdb = firebase.database();

let sid = localStorage.getItem('m_taha_session');
let data = { p: [], s: [] };

function handleAuth() {
    const code = document.getElementById('auth-input').value.trim();
    rdb.ref('active_stores/'+code).once('value', s => {
        if(s.exists()){ localStorage.setItem('m_taha_session', code); location.reload(); }
        else alert("ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­!");
    });
}

if(sid) {
    rdb.ref('active_stores/'+sid).on('value', s => {
        if(!s.exists()) logout();
        else {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-ui').style.display = 'block';
            document.getElementById('ui-store-name').innerText = s.val().name;
            rdb.ref('stores_data/'+sid).on('value', ss => {
                data = ss.val() || { p: [], s: [] };
                render();
            });
        }
    });
    rdb.ref('admin_announcement').on('value', s => {
        const t = document.getElementById('announcement');
        if(s.val()){ t.innerText = "ğŸ“¢ " + s.val(); t.style.display = 'block'; }
        else t.style.display = 'none';
    });
}

function tab(t, btn) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('p-'+t).classList.add('active');
    btn.classList.add('active');
}

function searchPr() {
    const q = document.getElementById('p-search').value.toLowerCase();
    const list = document.getElementById('p-list'); list.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        if(p.name.toLowerCase().includes(q)) list.innerHTML += `<option value="${i}">${p.name}</option>`;
    });
}

function saveSale() {
    const idx = document.getElementById('p-list').value;
    const qty = +document.getElementById('s-qty').value;
    const pr = +document.getElementById('s-price').value;
    if(idx==="" || qty <= 0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if(!data.s) data.s = [];
    data.s.push({ n: data.p[idx].name, q: qty, t: qty*pr, c: qty*data.p[idx].buy });
    sync();
    alert("ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ âœ…");
}

function addPr() {
    const n = document.getElementById('in-name').value, b = +document.getElementById('in-buy').value, s = +document.getElementById('in-sell').value;
    if(!n || b<=0) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    if(!data.p) data.p = [];
    data.p.push({name:n, buy:b, sell:s, qty:0});
    sync();
}

function sync() { rdb.ref('stores_data/'+sid).set(data); }

function render() {
    let profit = 0;
    (data.s || []).forEach(x => { profit += (x.t - x.c); });
    document.getElementById('res-profit').innerText = profit.toLocaleString() + " Ø¬";
    const inv = document.getElementById('stock-render'); inv.innerHTML = "";
    (data.p || []).forEach((p, i) => {
        inv.innerHTML += `<div class="card app-card p-3 mb-2 d-flex flex-row justify-content-between">
            <b>${p.name}</b>
            <button class="btn btn-sm text-danger" onclick="delPr(${i})">Ø­Ø°Ù</button>
        </div>`;
    });
}

function delPr(i) { if(confirm("Ø­Ø°ÙØŸ")) { data.p.splice(i,1); sync(); } }
function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
